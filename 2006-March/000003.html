<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Blahtex-cvs] blahtex/blahtex/source mainPng.h,NONE,1.1 Messages.cpp,1.3,1.4 UnicodeConverter.cpp,1.3,1.4 UnicodeConverter.h,1.3,1.4 main.cpp,1.3,1.4 mainPng.cpp,1.1,1.2 md5.c,1.3,1.4 md5.h,1.3,1.4 md5Wrapper.cpp,1.3,1.4 md5Wrapper.h,1.3,1.4
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/blahtex-cvs/2006-March/index.html" >
   <LINK REL="made" HREF="mailto:blahtex-cvs%40lists.berlios.de?Subject=Re%3A%20%5BBlahtex-cvs%5D%20blahtex/blahtex/source%20mainPng.h%2CNONE%2C1.1%20Messages.cpp%2C1.3%2C1.4%20UnicodeConverter.cpp%2C1.3%2C1.4%20UnicodeConverter.h%2C1.3%2C1.4%20main.cpp%2C1.3%2C1.4%20mainPng.cpp%2C1.1%2C1.2%20md5.c%2C1.3%2C1.4%20md5.h%2C1.3%2C1.4%20md5Wrapper.cpp%2C1.3%2C1.4%20md5Wrapper.h%2C1.3%2C1.4&In-Reply-To=%3C200603141213.k2ECDgb06509%40bat.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000002.html">
   <LINK REL="Next"  HREF="000004.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Blahtex-cvs] blahtex/blahtex/source mainPng.h,NONE,1.1 Messages.cpp,1.3,1.4 UnicodeConverter.cpp,1.3,1.4 UnicodeConverter.h,1.3,1.4 main.cpp,1.3,1.4 mainPng.cpp,1.1,1.2 md5.c,1.3,1.4 md5.h,1.3,1.4 md5Wrapper.cpp,1.3,1.4 md5Wrapper.h,1.3,1.4</H1>
    <B>jitseniesen</B> 
    <A HREF="mailto:blahtex-cvs%40lists.berlios.de?Subject=Re%3A%20%5BBlahtex-cvs%5D%20blahtex/blahtex/source%20mainPng.h%2CNONE%2C1.1%20Messages.cpp%2C1.3%2C1.4%20UnicodeConverter.cpp%2C1.3%2C1.4%20UnicodeConverter.h%2C1.3%2C1.4%20main.cpp%2C1.3%2C1.4%20mainPng.cpp%2C1.1%2C1.2%20md5.c%2C1.3%2C1.4%20md5.h%2C1.3%2C1.4%20md5Wrapper.cpp%2C1.3%2C1.4%20md5Wrapper.h%2C1.3%2C1.4&In-Reply-To=%3C200603141213.k2ECDgb06509%40bat.berlios.de%3E"
       TITLE="[Blahtex-cvs] blahtex/blahtex/source mainPng.h,NONE,1.1 Messages.cpp,1.3,1.4 UnicodeConverter.cpp,1.3,1.4 UnicodeConverter.h,1.3,1.4 main.cpp,1.3,1.4 mainPng.cpp,1.1,1.2 md5.c,1.3,1.4 md5.h,1.3,1.4 md5Wrapper.cpp,1.3,1.4 md5Wrapper.h,1.3,1.4">nobody at sheep.berlios.de
       </A><BR>
    <I>Tue Mar 14 13:13:42 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000002.html">[Blahtex-cvs] blahtex/blahtex makefile,1.10,1.11
</A></li>
        <LI>Next message: <A HREF="000004.html">[Blahtex-cvs] blahtex/includes DefaultSettings.php,1.13,1.14
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3">[ date ]</a>
              <a href="thread.html#3">[ thread ]</a>
              <a href="subject.html#3">[ subject ]</a>
              <a href="author.html#3">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/blahtex/blahtex/blahtex/source
In directory sheep:/tmp/cvs-serv4996/source

Modified Files:
	Messages.cpp UnicodeConverter.cpp UnicodeConverter.h main.cpp 
	mainPng.cpp md5.c md5.h md5Wrapper.cpp md5Wrapper.h 
Added Files:
	mainPng.h 
Log Message:
New blahtex version: 0.4.4


--- NEW FILE: mainPng.h ---
// File &quot;mainPng.h&quot;
//
// blahtex (version 0.4.4)
// a TeX to MathML converter designed with MediaWiki in mind
// Copyright (C) 2006, David Harvey
//
// This program is free software; you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation; either version 2 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA

#ifndef BLAHTEX_MAINPNG_H
#define BLAHTEX_MAINPNG_H

#include &lt;string&gt;

// Records information about a PNG file generated by MakePngFile.
struct PngInfo
{
    // The PNG is stored in md5.png.
    std::string mMd5;
    
    // These are the height and depth reported by dvipng.
    // They are only valid if mDimensionsValid is set.
    bool mDimensionsValid;
    int mHeight;
    int mDepth;
    
    PngInfo() :
        mDimensionsValid(false)
    { }
};

// Generates a PNG file. Uses tempDirectory for storage of temporary files
// (.tex, .dvi, .log, .data). Expects tempDirectory and pngDirectory to
// include a terminating slash. The output file will be stored in the
// directory pngDirectory in the file pngFilename; if pngFilename is an
// empty string, MakePngFile will just use the md5 that it computes (which
// gets returned in PngInfo).
extern PngInfo MakePngFile(
    const std::wstring&amp; purifiedTex,
    const std::string&amp; tempDirectory,
    const std::string&amp; pngDirectory,
    const std::string&amp; pngFilename,
    const std::string&amp; shellLatex,
    const std::string&amp; shellDvipng,
    bool deleteTempFiles
);


#endif

// end of file @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Index: Messages.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/Messages.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** Messages.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- Messages.cpp	14 Mar 2006 11:15:02 -0000	1.4
***************
*** 1,5 ****
  // File &quot;Messages.cpp&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;Messages.cpp&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
***************
*** 29,33 ****
  // The sequences $0, $1, etc correspond to the numbered arguments of the
  // error.
! //
  // FIX: a future version of the command line application should have a
  // &quot;--language&quot; option and read error messages from a file.
--- 29,33 ----
  // The sequences $0, $1, etc correspond to the numbered arguments of the
  // error.
! 
  // FIX: a future version of the command line application should have a
  // &quot;--language&quot; option and read error messages from a file.
***************
*** 54,57 ****
--- 54,61 ----
      ),
  
+     make_pair(L&quot;InvalidColour&quot;,
+         L&quot;The colour \&quot;$0\&quot; is invalid&quot;
+     ),
+ 
      make_pair(L&quot;IllegalFinalBackslash&quot;,
          L&quot;Illegal backslash \&quot;\\\&quot; at end of input&quot;
***************
*** 195,209 ****
      ),
  
      make_pair(L&quot;UnavailableSymbolFontCombination&quot;,
          L&quot;The symbol \&quot;$0\&quot; is not available in the font \&quot;$1\&quot;&quot;
      ),
  
-     make_pair(L&quot;InvalidNegation&quot;,
-         L&quot;No negative version of the symbol(s) following &quot;
-         L&quot;\&quot;\\not\&quot; is available&quot;
-     ),
- 
-     // Errors specific to generating MathML:
- 
      make_pair(L&quot;TooManyMathmlNodes&quot;,
          L&quot;There are too many nodes in the MathML tree&quot;
--- 199,208 ----
      ),
  
+     // Errors specific to generating MathML:
+ 
      make_pair(L&quot;UnavailableSymbolFontCombination&quot;,
          L&quot;The symbol \&quot;$0\&quot; is not available in the font \&quot;$1\&quot;&quot;
      ),
  
      make_pair(L&quot;TooManyMathmlNodes&quot;,
          L&quot;There are too many nodes in the MathML tree&quot;
***************
*** 215,219 ****
--- 214,240 ----
          L&quot;Unable to correctly generate PNG containing the character $0&quot;
      ),
+     
+     make_pair(L&quot;WrongFontEncoding&quot;,
+         L&quot;The symbol \&quot;$0\&quot; may not appear in font encoding \&quot;$1\&quot;&quot;
+     ),
+     
+     make_pair(L&quot;WrongFontEncodingWithHint&quot;,
+         L&quot;The symbol \&quot;$0\&quot; may not appear in font encoding \&quot;$1\&quot; &quot;
+         L&quot;(try using the \&quot;$2{...}\&quot; command)&quot;
+     ),
+     
+     make_pair(L&quot;IllegalNestedFontEncodings&quot;,
+         L&quot;Font encoding commands may not be nested&quot;
+     ),
  
+     make_pair(L&quot;LatexPackageUnavailable&quot;,
+         L&quot;Unable to render PNG because &quot;
+         L&quot;the LaTeX package \&quot;$0\&quot; is unavailable&quot;
+     ),
+ 
+     make_pair(L&quot;LatexFontNotSpecified&quot;,
+         L&quot;No LaTeX font has been specified for \&quot;$0\&quot;&quot;
+     ),
+         
      // Now we have errors which may be generated by the command-line
      // application (i.e. by main.cpp)
***************
*** 235,244 ****
      ),
  
!     make_pair(L&quot;CannotRunDvips&quot;,
!         L&quot;Cannot run dvips&quot;
      ),
! 
!     make_pair(L&quot;CannotRunConvert&quot;,
!         L&quot;Cannot run convert (ImageMagick)&quot;
      ),
  
--- 256,265 ----
      ),
  
!     make_pair(L&quot;CannotRunDvipng&quot;,
!         L&quot;Cannot run dvipng&quot;
      ),
!     
!     make_pair(L&quot;CannotWritePngDirectory&quot;,
!         L&quot;Cannot write to output PNG directory&quot;
      ),
  
***************
*** 253,256 ****
--- 274,278 ----
  );
  
+ 
  // GetErrorMessage() converts the given exception into an English
  // string, using the table gEnglishMessagesTable.
***************
*** 286,289 ****
--- 308,312 ----
      return message;
  }
+ 
  
  // Returns a string containing a list of all possible error code and

Index: UnicodeConverter.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/UnicodeConverter.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** UnicodeConverter.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- UnicodeConverter.cpp	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File &quot;UnicodeConverter.cpp&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;UnicodeConverter.cpp&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey

Index: UnicodeConverter.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/UnicodeConverter.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** UnicodeConverter.h	12 Feb 2006 22:56:33 -0000	1.3
--- UnicodeConverter.h	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File &quot;UnicodeConverter.h&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;UnicodeConverter.h&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey

Index: main.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/main.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** main.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- main.cpp	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File &quot;main.cpp&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;main.cpp&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
***************
*** 21,24 ****
--- 21,25 ----
  #include &quot;BlahtexCore/Interface.h&quot;
  #include &quot;UnicodeConverter.h&quot;
+ #include &quot;mainPng.h&quot;
  #include &lt;iostream&gt;
  #include &lt;sstream&gt;
***************
*** 28,32 ****
  using namespace blahtex;
  
! string gBlahtexVersion = &quot;0.4.2&quot;;
  
  // A single global instance of UnicodeConverter.
--- 29,33 ----
  using namespace blahtex;
  
! string gBlahtexVersion = &quot;0.4.4&quot;;
  
  // A single global instance of UnicodeConverter.
***************
*** 37,54 ****
  extern wstring GetErrorMessages();
  
- // Imported from mainPng.cpp:
- extern pair&lt;string, int&gt; MakePngFile(
-     const wstring&amp; purifiedTex,
-     bool computeVerticalShift,
-     const string&amp; tempDirectory,
-     const string&amp; pngDirectory,
-     const string&amp; shellLatex,
-     const string&amp; shellDvips,
-     const string&amp; shellConvert,
-     const string&amp; imageMagickOptions,
-     bool deleteTempFiles
- );
- 
- 
  // FormatError() converts a blahtex Exception object into a string like
  // &quot;&lt;error&gt;&lt;id&gt;...&lt;/id&gt;&lt;arg&gt;...&lt;/arg&gt;&lt;arg&gt;...&lt;/arg&gt; ...
--- 38,41 ----
***************
*** 87,185 ****
  &quot;Usage: blahtex [ options ] &lt; inputfile &gt; outputfile\n&quot;
  &quot;\n&quot;
! &quot;INPUT OPTIONS\n&quot;
  &quot;\n&quot;
  &quot; --texvc-compatible-commands\n&quot;
- &quot;     recognise nonstandard texvc-specific commands\n&quot;
- &quot;\n&quot;
- &quot;MATHML OPTIONS\n&quot;
  &quot;\n&quot;
  &quot; --mathml\n&quot;
- &quot;     generate MathML output\n&quot;
  &quot; --indented\n&quot;
! &quot;     produce nicely indented MathML tags\n&quot;
! &quot;\n&quot;
! &quot; --spacing strict\n&quot;
! &quot;     emit MathML spacing markup wherever possible\n&quot;
! &quot; --spacing moderate (default)\n&quot;
! &quot;     emit spacing markup where a MathML renderer is likely to\n&quot;
! &quot;     have trouble\n&quot;
! &quot; --spacing relaxed\n&quot;
! &quot;     emit spacing markup only where specifically requested in\n&quot;
! &quot;     the TeX input\n&quot;
! &quot;\n&quot;
  &quot; --mathml-version-1-fonts\n&quot;
- &quot;     use character entities and MathML version 1 font attributes\n&quot;
- &quot;     instead of \&quot;mathvariant\&quot;\n&quot;
- &quot;\n&quot;
  &quot; --disallow-plane-1\n&quot;
! &quot;     force plane-1 MathML characters to be encoded as e.g. \&quot;&Afr;\&quot;\n&quot;
! &quot;     instead of e.g. \&quot;&amp;#x1d504;\&quot;\n&quot;
! &quot;\n&quot;
! &quot; --mathml-encoding raw\n&quot;
! &quot;     encode non-ASCII MathML characters as raw UTF-8\n&quot;
! &quot; --mathml-encoding numeric (default)\n&quot;
! &quot;     encode non-ASCII MathML characters as numeric codes\n&quot;
! &quot;     (like \&quot;&amp;#x2191;\&quot;)\n&quot;
! &quot; --mathml-encoding short\n&quot;
! &quot;     encode non-ASCII MathML characters using short names\n&quot;
! &quot;     (like \&quot;&uarr;\&quot;)\n&quot;
! &quot; --mathml-encoding long\n&quot;
! &quot;     encode non-ASCII MathML characters using long names\n&quot;
! &quot;     (like \&quot;&UpArrow;\&quot;)\n&quot;
! &quot;\n&quot;
! &quot; --other-encoding raw\n&quot;
! &quot;     encode non-ASCII, non-MathML characters as raw UTF-8\n&quot;
! &quot; --other-encoding numeric (default)\n&quot;
! &quot;     encode non-ASCII, non-MathML characters as numeric codes\n&quot;
! &quot;\n&quot;
! &quot;PNG OPTIONS\n&quot;
  &quot;\n&quot;
  &quot; --png\n&quot;
- &quot;     generate PNG output\n&quot;
- &quot;\n&quot;
  &quot; --use-ucs-package\n&quot;
! &quot;     use the LaTeX ucs package to handle some non-ASCII characters\n&quot;
! #ifdef BLAHTEX_USING_MAGICK
! &quot;\n&quot;
! &quot; --compute-vertical-shift\n&quot;
! &quot;     determine the location of the baseline of the equation, and output\n&quot;
! &quot;     the number of pixels to shift (SOMEWHAT EXPERIMENTAL)\n&quot;
! #endif
! &quot;\n&quot;
  &quot; --shell-latex  command\n&quot;
! &quot; --shell-dvips  command\n&quot;
! &quot; --shell-convert  command\n&quot;
! &quot;     indicates commands for latex, dvips, ImageMagick utilities\n&quot;
! &quot;     (default is just \&quot;latex\&quot;, \&quot;dvips\&quot;, \&quot;convert\&quot;)\n&quot;
! &quot;\n&quot;
! &quot; --convert-options  options-string\n&quot;
! &quot;     indicates options to be passed to ImageMagick convert utility\n&quot;
! &quot;     (default is:\n&quot;
! &quot;     -quality 100 -density 120 -matte -fill None -opaque White)\n&quot;
! &quot;\n&quot;
  &quot; --temp-directory  directory\n&quot;
- &quot;     which directory to use for temp files (.tex, .aux, .log, .dvi, .ps)\n&quot;
- &quot;     (default is current directory)\n&quot;
  &quot; --png-directory  directory\n&quot;
- &quot;     where to put the output PNG file\n&quot;
- &quot;     (default is current directory)\n&quot;
- &quot;\n&quot;
- &quot;DEBUGGING OPTIONS\n&quot;
- &quot;\n&quot;
- &quot; --debug parse\n&quot;
- &quot;     display the parse tree (output is NOT XML)\n&quot;
- &quot; --debug layout\n&quot;
- &quot;     display the layout tree (output is NOT XML)\n&quot;
- &quot; --debug purified\n&quot;
- &quot;     display purified TeX (output is NOT XML)\n&quot;
  &quot;\n&quot;
  &quot; --keep-temp-files\n&quot;
- &quot;     don't delete temporary files used during PNG generation\n&quot;
- &quot;\n&quot;
  &quot; --throw-logic-error\n&quot;
- &quot;     simulate a debug assertion occurring\n&quot;
- &quot;\n&quot;
  &quot; --print-error-messages\n&quot;
- &quot;     print a list of all the errors that blahtex can produce\n&quot;
  &quot;\n&quot;
  &quot;More information available at www.blahtex.org\n&quot;
--- 74,102 ----
  &quot;Usage: blahtex [ options ] &lt; inputfile &gt; outputfile\n&quot;
  &quot;\n&quot;
! &quot;SUMMARY OF OPTIONS (see manual for details)\n&quot;
  &quot;\n&quot;
  &quot; --texvc-compatible-commands\n&quot;
  &quot;\n&quot;
  &quot; --mathml\n&quot;
  &quot; --indented\n&quot;
! &quot; --spacing { strict | moderate | relaxed }\n&quot;
  &quot; --mathml-version-1-fonts\n&quot;
  &quot; --disallow-plane-1\n&quot;
! &quot; --mathml-encoding { raw | numeric | short | long }\n&quot;
! &quot; --other-encoding { raw | numeric }\n&quot;
  &quot;\n&quot;
  &quot; --png\n&quot;
  &quot; --use-ucs-package\n&quot;
! &quot; --use-cjk-package\n&quot;
! &quot; --japanese-font  fontname\n&quot;
  &quot; --shell-latex  command\n&quot;
! &quot; --shell-dvipng  command\n&quot;
  &quot; --temp-directory  directory\n&quot;
  &quot; --png-directory  directory\n&quot;
  &quot;\n&quot;
+ &quot; --debug { parse | layout | purified }\n&quot;
  &quot; --keep-temp-files\n&quot;
  &quot; --throw-logic-error\n&quot;
  &quot; --print-error-messages\n&quot;
  &quot;\n&quot;
  &quot;More information available at www.blahtex.org\n&quot;
***************
*** 223,233 ****
          bool debugParseTree   = false;
          bool debugPurifiedTex = false;
!         bool deleteTempFiles = true;
  
          string shellLatex   = &quot;latex&quot;;
!         string shellDvips   = &quot;dvips&quot;;
!         string shellConvert = &quot;convert&quot;;
!         string imageMagickOptions =
!             &quot;-quality 100 -density 120 -matte -fill None -opaque White&quot;;
          string tempDirectory = &quot;./&quot;;
          string  pngDirectory = &quot;./&quot;;
--- 140,147 ----
          bool debugParseTree   = false;
          bool debugPurifiedTex = false;
!         bool deleteTempFiles  = true;
  
          string shellLatex   = &quot;latex&quot;;
!         string shellDvipng  = &quot;dvipng&quot;;
          string tempDirectory = &quot;./&quot;;
          string  pngDirectory = &quot;./&quot;;
***************
*** 260,288 ****
              }
  
!             else if (arg == &quot;--shell-dvips&quot;)
!             {
!                 if (++i == argc)
!                     throw CommandLineException(
!                         &quot;Missing string after \&quot;--shell-dvips\&quot;&quot;
!                     );
!                 shellDvips = string(argv[i]);
!             }
! 
!             else if (arg == &quot;--shell-convert&quot;)
!             {
!                 if (++i == argc)
!                     throw CommandLineException(
!                         &quot;Missing string after \&quot;--shell-convert\&quot;&quot;
!                     );
!                 shellConvert = string(argv[i]);
!             }
! 
!             else if (arg == &quot;--convert-options&quot;)
              {
                  if (++i == argc)
                      throw CommandLineException(
!                         &quot;Missing string after \&quot;--convert-options\&quot;&quot;
                      );
!                 imageMagickOptions = string(argv[i]);
              }
  
--- 174,184 ----
              }
  
!             else if (arg == &quot;--shell-dvipng&quot;)
              {
                  if (++i == argc)
                      throw CommandLineException(
!                         &quot;Missing string after \&quot;--shell-dvipng\&quot;&quot;
                      );
!                 shellDvipng = string(argv[i]);
              }
  
***************
*** 307,310 ****
--- 203,222 ----
              }
  
+             else if (arg == &quot;--use-ucs-package&quot;)
+                 interface.mPurifiedTexOptions.mAllowUcs = true;
+ 
+             else if (arg == &quot;--use-cjk-package&quot;)
+                 interface.mPurifiedTexOptions.mAllowCJK = true;
+             
+             else if (arg == &quot;--japanese-font&quot;)
+             {
+                 if (++i == argc)
+                     throw CommandLineException(
+                         &quot;Missing string after \&quot;--japanese-font\&quot;&quot;
+                     );
+                 interface.mPurifiedTexOptions.mJapaneseFont =
+                     gUnicodeConverter.ConvertIn(string(argv[i]));
+             }
+ 
              else if (arg == &quot;--indented&quot;)
                  interface.mIndented = true;
***************
*** 336,341 ****
              }
  
-             else if (arg == &quot;--use-ucs-package&quot;)
-                 interface.mPurifiedTexOptions.mUseUcsPackage = true;
  
              else if (arg == &quot;--mathml-version-1-fonts&quot;)
--- 248,251 ----
***************
*** 348,356 ****
                  doPng = true;
  
- #ifdef BLAHTEX_USING_MAGICK
-             else if (arg == &quot;--compute-vertical-shift&quot;)
-                 interface.mPurifiedTexOptions.mComputeVerticalShift = true;
- #endif
- 
              else if (arg == &quot;--mathml&quot;)
                  doMathml = true;
--- 258,261 ----
***************
*** 508,530 ****
                      if (doPng)
                      {
!                         pair&lt;string, int&gt; pngData = MakePngFile(
                              purifiedTex,
-                             interface.mPurifiedTexOptions.
-                                 mComputeVerticalShift,
                              tempDirectory,
                              pngDirectory,
                              shellLatex,
!                             shellDvips,
!                             shellConvert,
!                             imageMagickOptions,
                              deleteTempFiles
                          );
  
!                         if (pngData.second != 1)
!                             pngOutput &lt;&lt; L&quot;&lt;vshift&gt;&quot;
!                                 &lt;&lt; pngData.second &lt;&lt; L&quot;&lt;/vshift&gt;\n&quot;;
  
                          pngOutput &lt;&lt; L&quot;&lt;md5&gt;&quot;
!                             &lt;&lt; gUnicodeConverter.ConvertIn(pngData.first)
                              &lt;&lt; L&quot;&lt;/md5&gt;\n&quot;;
                      }
--- 413,436 ----
                      if (doPng)
                      {
!                         PngInfo info = MakePngFile(
                              purifiedTex,
                              tempDirectory,
                              pngDirectory,
+                             &quot;&quot;,
                              shellLatex,
!                             shellDvipng,
                              deleteTempFiles
                          );
  
!                         if (info.mDimensionsValid)
!                         {
!                             pngOutput &lt;&lt; L&quot;&lt;height&gt;&quot;
!                                 &lt;&lt; info.mHeight &lt;&lt; L&quot;&lt;/height&gt;\n&quot;;
!                             pngOutput &lt;&lt; L&quot;&lt;depth&gt;&quot;
!                                 &lt;&lt; info.mDepth &lt;&lt; L&quot;&lt;/depth&gt;\n&quot;;
!                         }
  
                          pngOutput &lt;&lt; L&quot;&lt;md5&gt;&quot;
!                             &lt;&lt; gUnicodeConverter.ConvertIn(info.mMd5)
                              &lt;&lt; L&quot;&lt;/md5&gt;\n&quot;;
                      }
***************
*** 552,556 ****
                      mathmlOutput &lt;&lt; L&quot;&lt;markup&gt;\n&quot;;
                      mathmlOutput &lt;&lt; interface.GetMathml();
!                     mathmlOutput &lt;&lt; L&quot;\n&lt;/markup&gt;\n&quot;;
                  }
  
--- 458,464 ----
                      mathmlOutput &lt;&lt; L&quot;&lt;markup&gt;\n&quot;;
                      mathmlOutput &lt;&lt; interface.GetMathml();
!                     if (!interface.mIndented)
!                         mathmlOutput &lt;&lt; L&quot;\n&quot;;
!                     mathmlOutput &lt;&lt; L&quot;&lt;/markup&gt;\n&quot;;
                  }
  
***************
*** 596,600 ****
      catch (CommandLineException&amp; e)
      {
!         cout &lt;&lt; &quot;Blahtex: &quot; &lt;&lt; e.mMessage &lt;&lt; &quot; (try \&quot;blahtex --help\&quot;)\n&quot;;
      }
  
--- 504,508 ----
      catch (CommandLineException&amp; e)
      {
!         cout &lt;&lt; &quot;blahtex: &quot; &lt;&lt; e.mMessage &lt;&lt; &quot; (try \&quot;blahtex --help\&quot;)\n&quot;;
      }
  
***************
*** 603,607 ****
      catch (std::runtime_error&amp; e)
      {
!         cout &lt;&lt; &quot;Blahtex runtime error: &quot; &lt;&lt; e.what() &lt;&lt; endl;
      }
  
--- 511,515 ----
      catch (std::runtime_error&amp; e)
      {
!         cout &lt;&lt; &quot;blahtex runtime error: &quot; &lt;&lt; e.what() &lt;&lt; endl;
      }
  

Index: mainPng.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/mainPng.cpp,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** mainPng.cpp	12 Feb 2006 23:28:01 -0000	1.1
--- mainPng.cpp	14 Mar 2006 11:15:03 -0000	1.2
***************
*** 1,5 ****
  // File &quot;mainPng.cpp&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;mainPng.cpp&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
***************
*** 19,32 ****
  // Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
  
- #ifdef BLAHTEX_USING_MAGICK
- #include &lt;Magick++.h&gt;
- #endif
- 
  #include &quot;BlahtexCore/Misc.h&quot;
  #include &quot;UnicodeConverter.h&quot;
  #include &quot;md5Wrapper.h&quot;
  #include &lt;cerrno&gt;
  #include &lt;sys/stat.h&gt;
- #include &lt;string&gt;
  #include &lt;iostream&gt;
  #include &lt;fstream&gt;
--- 19,28 ----
  // Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
  
  #include &quot;BlahtexCore/Misc.h&quot;
  #include &quot;UnicodeConverter.h&quot;
  #include &quot;md5Wrapper.h&quot;
+ #include &quot;mainPng.h&quot;
  #include &lt;cerrno&gt;
  #include &lt;sys/stat.h&gt;
  #include &lt;iostream&gt;
  #include &lt;fstream&gt;
***************
*** 97,101 ****
              throw blahtex::Exception(L&quot;CannotChangeDirectory&quot;);
      }
! 
      bool result = (system(command.c_str()) == 0);
  
--- 93,97 ----
              throw blahtex::Exception(L&quot;CannotChangeDirectory&quot;);
      }
!     
      bool result = (system(command.c_str()) == 0);
  
***************
*** 110,137 ****
  
  
! // Generates the PNG file, and computes vertical shift if requested.
! // Returns:
! //  * md5 of the UTF-8 version of the input.
! //  * vertical shift (a non-positive integer);
! //    or +1 if either the vertical shift was not requested, or if it
! //    could not be computed.
! pair&lt;string, int&gt; MakePngFile
! (
      const wstring&amp; purifiedTex,
-     bool computeVerticalShift,
      const string&amp; tempDirectory,
      const string&amp; pngDirectory,
      const string&amp; shellLatex,
!     const string&amp; shellDvips,
!     const string&amp; shellConvert,
!     const string&amp; imageMagickOptions,
      bool deleteTempFiles
  )
  {
      string purifiedTexUtf8 = gUnicodeConverter.ConvertOut(purifiedTex);
! 
      string md5 = ComputeMd5(purifiedTexUtf8);
-     int shift = 1;
  
      {
          ofstream texFile(
--- 106,130 ----
  
  
! PngInfo MakePngFile(
      const wstring&amp; purifiedTex,
      const string&amp; tempDirectory,
      const string&amp; pngDirectory,
+     const string&amp; pngFilename,
      const string&amp; shellLatex,
!     const string&amp; shellDvipng,
      bool deleteTempFiles
  )
  {
+     PngInfo info;
+     
      string purifiedTexUtf8 = gUnicodeConverter.ConvertOut(purifiedTex);
!     
!     // This md5 is used for the temp filenames.
      string md5 = ComputeMd5(purifiedTexUtf8);
  
+     string pngActualFilename =
+         pngFilename.empty() ? (md5 + &quot;.png&quot;) : pngFilename;
+ 
+     // Send output to tex file.
      {
          ofstream texFile(
***************
*** 150,168 ****
      }
  
!     // These are temporary files we want deleted
!     // when we're done.
!     TemporaryFile texTemp(tempDirectory + md5 + &quot;.tex&quot;, deleteTempFiles);
!     TemporaryFile auxTemp(tempDirectory + md5 + &quot;.aux&quot;, deleteTempFiles);
!     TemporaryFile logTemp(tempDirectory + md5 + &quot;.log&quot;, deleteTempFiles);
!     TemporaryFile dviTemp(tempDirectory + md5 + &quot;.dvi&quot;, deleteTempFiles);
!     TemporaryFile  psTemp(tempDirectory + md5 + &quot;.ps&quot;, deleteTempFiles);
!     TemporaryFile psOriginalTemp(
!         tempDirectory + md5 + &quot;-original.ps&quot;,
!         deleteTempFiles
!     );
  
-     // FIX: is the md5 hash enough here for the
-     // temporary file name? Should we also throw in a
-     // process ID, timestamp, or something?
  
      if (!Execute(
--- 143,153 ----
      }
  
!     // These are temporary files we want deleted when we're done.
!     TemporaryFile  texTemp(tempDirectory + md5 + &quot;.tex&quot;,  deleteTempFiles);
!     TemporaryFile  auxTemp(tempDirectory + md5 + &quot;.aux&quot;,  deleteTempFiles);
!     TemporaryFile  logTemp(tempDirectory + md5 + &quot;.log&quot;,  deleteTempFiles);
!     TemporaryFile  dviTemp(tempDirectory + md5 + &quot;.dvi&quot;,  deleteTempFiles);
!     TemporaryFile dataTemp(tempDirectory + md5 + &quot;.data&quot;, deleteTempFiles);
  
  
      if (!Execute(
***************
*** 176,313 ****
          throw blahtex::Exception(L&quot;CannotRunLatex&quot;);
  
      if (!Execute(
!         shellDvips + &quot; -R -E &quot; + tempDirectory + md5
!             + &quot;.dvi -f -o &quot; + tempDirectory + md5
!             + &quot;-original.ps 2&gt;/dev/null&quot;
          )
          ||
!         !FileExists(tempDirectory + md5 + &quot;-original.ps&quot;)
      )
!         throw blahtex::Exception(L&quot;CannotRunDvips&quot;);
  
!     // Extend the PS file's bounding box to the right a few pixels. This
!     // addresses the unfortunate situation that can occur when dvips messes
!     // up the bounding box; for example, a single integral sign
!     // (&quot;\displaystyle \int&quot;) gets chopped off.
      {
!         ifstream psInput(
!             (tempDirectory + md5 + &quot;-original.ps&quot;).c_str(),
              ios::in | ios::binary
          );
- 
-         ofstream psOutput(
-             (tempDirectory + md5 + &quot;.ps&quot;).c_str(),
-             ios::out | ios::binary
-         );
          
!         string line;
!         bool foundBoundingBox = false;
!         while (getline(psInput, line))
!         {
!             if (!foundBoundingBox &amp;&amp; line.substr(0, 14) == &quot;%%BoundingBox:&quot;)
!             {
!                 // Add 10 to the 3rd coordinate of the bounding box line
!                 foundBoundingBox = true;
!                 string half = line.substr(14, string::npos);
!                 istringstream decoder(half);
!                 int coord1, coord2, coord3, coord4;
!                 decoder &gt;&gt; coord1 &gt;&gt; coord2 &gt;&gt; coord3 &gt;&gt; coord4;
!                 ostringstream encoder;
!                 encoder &lt;&lt; &quot;%%BoundingBox: &quot;
!                     &lt;&lt; coord1 &lt;&lt; &quot; &quot;
!                     &lt;&lt; coord2 &lt;&lt; &quot; &quot;
!                     &lt;&lt; (coord3 + 10) &lt;&lt; &quot; &quot;
!                     &lt;&lt; coord4;
!                 line = encoder.str();
!             }
!             psOutput &lt;&lt; line &lt;&lt; endl;
!         }
!     }
! 
!     if (!Execute(
!         shellConvert + &quot; &quot; + imageMagickOptions
!             + &quot; -trim &quot; + tempDirectory + md5 + &quot;.ps &quot;
!             + pngDirectory + md5 + &quot;.png &quot;
!             + &quot; &gt;/dev/null 2&gt;/dev/null&quot;
!         )
!         ||
!         !FileExists(pngDirectory + md5 + &quot;.png&quot;)
!     )
!         throw blahtex::Exception(L&quot;CannotRunConvert&quot;);
! 
! #ifdef BLAHTEX_USING_MAGICK
!     if (computeVerticalShift)
!     {
!         try     // for Magick exceptions
          {
!             Magick::Image image(
!                 pngDirectory + md5 + &quot;.png&quot;
!             );
!             
!             unsigned width = image.baseColumns();
!             unsigned height = image.baseRows();
! 
!             // In Manager::GeneratePurifiedTex() we
!             // arranged for the PNG to have an extra
!             // pixel located on the baseline of the
!             // equation. Now we search for that pixel.
!             int row;
!             Magick::Pixels view(image);
!             Magick::PixelPacket* pixels = view.get(0, 0, 1, height);
!             for (row = 0; row &lt; height; ++row, ++pixels)
!                 if (pixels-&gt;red)
!                     break;
! 
!             if (row &lt; height)
              {
!                 // Found it.
!                 shift = row - height + 1;
! 
!                 // Remove the first column of the image.
!                 
!                 // FIX: I wanted to use the ImageMagick crop function, but
!                 // it seemed really buggy; it didn't seem to respect the
!                 // desired crop region accurately enough. So instead we just
!                 // create a new image from scratch and copy the pixels
!                 // across, one at a time.
!                 
!                 if (width &gt;= 2)
                  {
!                     Magick::Image newImage(
!                         Magick::Geometry(width - 2, height),
!                         Magick::Color(0, 0, 0, 0)
!                     );
!                     
!                     newImage.modifyImage();
!                     
!                     Magick::Pixels newView(newImage);
!                     
!                     Magick::PixelPacket* pixels =
!                         view.get(2, 0, width - 2, height);
! 
!                     Magick::PixelPacket* newPixels =
!                         newView.get(0, 0, width - 2, height);
!                     
!                     for (unsigned k = (width - 2) * height; k &gt; 0; --k)
!                         *newPixels++ = *pixels++;
!                     
!                     newView.sync();
!                     
!                     if (!deleteTempFiles)
!                         image.write(tempDirectory + md5 + &quot;-original.png&quot;);
! 
!                     newImage.write(pngDirectory + md5 + &quot;.png&quot;);
                  }
              }
          }
-         catch (Magick::Exception&amp; e)
-         {
-             // If imagemagick produces any exceptions,
-             // we just ignore it and give up on the
-             // vertical alignment stuff.
-         }
      }
- #endif
  
!     return make_pair(md5, shift);
  }
--- 161,214 ----
          throw blahtex::Exception(L&quot;CannotRunLatex&quot;);
  
+ 
      if (!Execute(
!             shellDvipng + &quot; &quot; + md5 + &quot;.dvi &quot; +
!                 &quot;--picky --bg Transparent --gamma 1.3 -D 120 -q &quot; +
!                 &quot;--height --depth &quot; +
!                 &quot;-o \&quot;&quot; + pngActualFilename +
!                 &quot;\&quot; &gt; &quot; + md5 + &quot;.data 2&gt;/dev/null&quot;, 
!             tempDirectory
          )
          ||
!         !FileExists(tempDirectory + pngActualFilename)
      )
!         throw blahtex::Exception(L&quot;CannotRunDvipng&quot;);
!         
!     if (rename(
!         (tempDirectory + pngActualFilename).c_str(),
!         (pngDirectory + pngActualFilename).c_str()
!     ))
!         throw blahtex::Exception(L&quot;CannotWritePngDirectory&quot;);
  
! 
!     // Read the height and depth of the image from dvipng's output.
      {
!         ifstream dataFile(
!             (tempDirectory + md5 + &quot;.data&quot;).c_str(),
              ios::in | ios::binary
          );
          
!         if (dataFile)
          {
!             string line, temp;
!             while (getline(dataFile, line))
              {
!                 string::size_type heightPos = line.find(&quot;height=&quot;);
!                 string::size_type depthPos = line.find(&quot;depth=&quot;);
!                 if (heightPos != string::npos &amp;&amp; depthPos != string::npos)
                  {
!                     info.mDimensionsValid = true;
!                     temp = line.substr(heightPos + 7, 1000);
!                     istringstream(temp) &gt;&gt; info.mHeight;
!                     string temp = line.substr(depthPos + 6, 1000);
!                     istringstream(temp) &gt;&gt; info.mDepth;
                  }
              }
          }
      }
  
!     info.mMd5 = md5;
!     return info;
  }
+ 
+ // end of file @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Index: md5.c
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4

Index: md5.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4

Index: md5Wrapper.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5Wrapper.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** md5Wrapper.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- md5Wrapper.cpp	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File &quot;md5Wrapper.cpp&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;md5Wrapper.cpp&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey

Index: md5Wrapper.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5Wrapper.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** md5Wrapper.h	12 Feb 2006 22:56:33 -0000	1.3
--- md5Wrapper.h	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File &quot;md5Wrapper.h&quot;
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File &quot;md5Wrapper.h&quot;
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000002.html">[Blahtex-cvs] blahtex/blahtex makefile,1.10,1.11
</A></li>
	<LI>Next message: <A HREF="000004.html">[Blahtex-cvs] blahtex/includes DefaultSettings.php,1.13,1.14
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3">[ date ]</a>
              <a href="thread.html#3">[ thread ]</a>
              <a href="subject.html#3">[ subject ]</a>
              <a href="author.html#3">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/blahtex-cvs">More information about the Blahtex-cvs
mailing list</a><br>
</body></html>
