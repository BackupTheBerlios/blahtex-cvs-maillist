From nobody at sheep.berlios.de  Tue Mar 14 13:13:42 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Tue, 14 Mar 2006 13:13:42 +0100
Subject: [Blahtex-cvs] blahtex/blahtex makefile,1.10,1.11
Message-ID: <200603141213.k2ECDgb06505@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex
In directory sheep:/tmp/cvs-serv4996

Modified Files:
	makefile 
Log Message:
New blahtex version: 0.4.4


Index: makefile
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/makefile,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** makefile	12 Feb 2006 22:56:33 -0000	1.10
--- makefile	14 Mar 2006 11:15:02 -0000	1.11
***************
*** 2,6 ****
  # makefile
  #
! # blahtex (version 0.4.2)
  # a TeX to MathML converter designed with MediaWiki in mind
  # Copyright (C) 2006, David Harvey
--- 2,6 ----
  # makefile
  #
! # blahtex (version 0.4.4)
  # a TeX to MathML converter designed with MediaWiki in mind
  # Copyright (C) 2006, David Harvey
***************
*** 22,43 ****
  
  
- # If you are building with imagemagick support (to enable the
- # "--compute-vertical-shift" option), you will need to set the
- # following directories to point to where your ImageMagick header/
- # library files are stored:
- 
- MAGICK_INCLUDE_DIR = /usr/include/
- MAGICK_LIB_DIR = /usr/lib/
- 
- # e.g. if you are using fink (Mac OS X), then probably you want
- 
- # MAGICK_INCLUDE_DIR = /sw/include/
- # MAGICK_LIB_DIR = /sw/lib/
- 
- # and if you are using DarwinPorts (Mac OS X), then probably you want
- 
- # MAGICK_INCLUDE_DIR = /opt/local/include/
- # MAGICK_LIB_DIR = /opt/local/lib/
- 
  SOURCES = \
  	source/main.cpp \
--- 22,25 ----
***************
*** 55,61 ****
  	source/BlahtexCore/ParseTree2.cpp \
  	source/BlahtexCore/ParseTree3.cpp \
! 	source/BlahtexCore/XmlNode.cpp
  	
  HEADERS = \
  	source/md5.h \
  	source/md5Wrapper.h \
--- 37,45 ----
  	source/BlahtexCore/ParseTree2.cpp \
  	source/BlahtexCore/ParseTree3.cpp \
! 	source/BlahtexCore/MathmlNode.cpp \
! 	source/BlahtexCore/XmlEncode.cpp
  	
  HEADERS = \
+ 	source/mainPng.h \
  	source/md5.h \
  	source/md5Wrapper.h \
***************
*** 68,92 ****
  	source/BlahtexCore/Parser.h \
  	source/BlahtexCore/ParseTree.h \
! 	source/BlahtexCore/XmlNode.h
  
  OBJECTS = $(patsubst %.c,%.o,$(patsubst %.cpp,%.o,$(SOURCES)))
  
! linux : CFLAGS = -O3 -DBLAHTEX_USING_MAGICK -I$(MAGICK_INCLUDE_DIR)
! mac : CFLAGS = -O3 -DBLAHTEX_ICONV_CONST -DBLAHTEX_USING_MAGICK -I$(MAGICK_INCLUDE_DIR)
! linux-without-imagemagick : CFLAGS = -O3
! mac-without-imagemagick : CFLAGS = -O3 -DBLAHTEX_ICONV_CONST
  
  CXXFLAGS = $(CFLAGS)
  
  linux:  $(OBJECTS)  $(HEADERS)
- 	$(CXX) $(CFLAGS) -o blahtex -lMagick++ -L$(MAGICK_LIB_DIR) $(OBJECTS)
- 
- mac: $(OBJECTS)  $(HEADERS)
- 	$(CXX) $(CFLAGS) -o blahtex -liconv -lMagick++ -L$(MAGICK_LIB_DIR) $(OBJECTS)
- 
- linux-without-imagemagick:  $(OBJECTS)  $(HEADERS)
  	$(CXX) $(CFLAGS) -o blahtex $(OBJECTS)
  
! mac-without-imagemagick: $(OBJECTS)  $(HEADERS)
  	$(CXX) $(CFLAGS) -o blahtex -liconv $(OBJECTS)
  
--- 52,69 ----
  	source/BlahtexCore/Parser.h \
  	source/BlahtexCore/ParseTree.h \
! 	source/BlahtexCore/MathmlNode.h \
! 	source/BlahtexCore/XmlEncode.h
  
  OBJECTS = $(patsubst %.c,%.o,$(patsubst %.cpp,%.o,$(SOURCES)))
  
! linux : CFLAGS = -O3
! mac : CFLAGS = -O3 -DBLAHTEX_ICONV_CONST
  
  CXXFLAGS = $(CFLAGS)
  
  linux:  $(OBJECTS)  $(HEADERS)
  	$(CXX) $(CFLAGS) -o blahtex $(OBJECTS)
  
! mac: $(OBJECTS)  $(HEADERS)
  	$(CXX) $(CFLAGS) -o blahtex -liconv $(OBJECTS)
  



From nobody at sheep.berlios.de  Tue Mar 14 13:13:42 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Tue, 14 Mar 2006 13:13:42 +0100
Subject: [Blahtex-cvs] blahtex/blahtex/source mainPng.h,NONE,1.1 Messages.cpp,1.3,1.4 UnicodeConverter.cpp,1.3,1.4 UnicodeConverter.h,1.3,1.4 main.cpp,1.3,1.4 mainPng.cpp,1.1,1.2 md5.c,1.3,1.4 md5.h,1.3,1.4 md5Wrapper.cpp,1.3,1.4 md5Wrapper.h,1.3,1.4
Message-ID: <200603141213.k2ECDgb06509@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex/source
In directory sheep:/tmp/cvs-serv4996/source

Modified Files:
	Messages.cpp UnicodeConverter.cpp UnicodeConverter.h main.cpp 
	mainPng.cpp md5.c md5.h md5Wrapper.cpp md5Wrapper.h 
Added Files:
	mainPng.h 
Log Message:
New blahtex version: 0.4.4


--- NEW FILE: mainPng.h ---
// File "mainPng.h"
//
// blahtex (version 0.4.4)
// a TeX to MathML converter designed with MediaWiki in mind
// Copyright (C) 2006, David Harvey
//
// This program is free software; you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation; either version 2 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA

#ifndef BLAHTEX_MAINPNG_H
#define BLAHTEX_MAINPNG_H

#include <string>

// Records information about a PNG file generated by MakePngFile.
struct PngInfo
{
    // The PNG is stored in md5.png.
    std::string mMd5;
    
    // These are the height and depth reported by dvipng.
    // They are only valid if mDimensionsValid is set.
    bool mDimensionsValid;
    int mHeight;
    int mDepth;
    
    PngInfo() :
        mDimensionsValid(false)
    { }
};

// Generates a PNG file. Uses tempDirectory for storage of temporary files
// (.tex, .dvi, .log, .data). Expects tempDirectory and pngDirectory to
// include a terminating slash. The output file will be stored in the
// directory pngDirectory in the file pngFilename; if pngFilename is an
// empty string, MakePngFile will just use the md5 that it computes (which
// gets returned in PngInfo).
extern PngInfo MakePngFile(
    const std::wstring& purifiedTex,
    const std::string& tempDirectory,
    const std::string& pngDirectory,
    const std::string& pngFilename,
    const std::string& shellLatex,
    const std::string& shellDvipng,
    bool deleteTempFiles
);


#endif

// end of file @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Index: Messages.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/Messages.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** Messages.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- Messages.cpp	14 Mar 2006 11:15:02 -0000	1.4
***************
*** 1,5 ****
  // File "Messages.cpp"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "Messages.cpp"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
***************
*** 29,33 ****
  // The sequences $0, $1, etc correspond to the numbered arguments of the
  // error.
! //
  // FIX: a future version of the command line application should have a
  // "--language" option and read error messages from a file.
--- 29,33 ----
  // The sequences $0, $1, etc correspond to the numbered arguments of the
  // error.
! 
  // FIX: a future version of the command line application should have a
  // "--language" option and read error messages from a file.
***************
*** 54,57 ****
--- 54,61 ----
      ),
  
+     make_pair(L"InvalidColour",
+         L"The colour \"$0\" is invalid"
+     ),
+ 
      make_pair(L"IllegalFinalBackslash",
          L"Illegal backslash \"\\\" at end of input"
***************
*** 195,209 ****
      ),
  
      make_pair(L"UnavailableSymbolFontCombination",
          L"The symbol \"$0\" is not available in the font \"$1\""
      ),
  
-     make_pair(L"InvalidNegation",
-         L"No negative version of the symbol(s) following "
-         L"\"\\not\" is available"
-     ),
- 
-     // Errors specific to generating MathML:
- 
      make_pair(L"TooManyMathmlNodes",
          L"There are too many nodes in the MathML tree"
--- 199,208 ----
      ),
  
+     // Errors specific to generating MathML:
+ 
      make_pair(L"UnavailableSymbolFontCombination",
          L"The symbol \"$0\" is not available in the font \"$1\""
      ),
  
      make_pair(L"TooManyMathmlNodes",
          L"There are too many nodes in the MathML tree"
***************
*** 215,219 ****
--- 214,240 ----
          L"Unable to correctly generate PNG containing the character $0"
      ),
+     
+     make_pair(L"WrongFontEncoding",
+         L"The symbol \"$0\" may not appear in font encoding \"$1\""
+     ),
+     
+     make_pair(L"WrongFontEncodingWithHint",
+         L"The symbol \"$0\" may not appear in font encoding \"$1\" "
+         L"(try using the \"$2{...}\" command)"
+     ),
+     
+     make_pair(L"IllegalNestedFontEncodings",
+         L"Font encoding commands may not be nested"
+     ),
  
+     make_pair(L"LatexPackageUnavailable",
+         L"Unable to render PNG because "
+         L"the LaTeX package \"$0\" is unavailable"
+     ),
+ 
+     make_pair(L"LatexFontNotSpecified",
+         L"No LaTeX font has been specified for \"$0\""
+     ),
+         
      // Now we have errors which may be generated by the command-line
      // application (i.e. by main.cpp)
***************
*** 235,244 ****
      ),
  
!     make_pair(L"CannotRunDvips",
!         L"Cannot run dvips"
      ),
! 
!     make_pair(L"CannotRunConvert",
!         L"Cannot run convert (ImageMagick)"
      ),
  
--- 256,265 ----
      ),
  
!     make_pair(L"CannotRunDvipng",
!         L"Cannot run dvipng"
      ),
!     
!     make_pair(L"CannotWritePngDirectory",
!         L"Cannot write to output PNG directory"
      ),
  
***************
*** 253,256 ****
--- 274,278 ----
  );
  
+ 
  // GetErrorMessage() converts the given exception into an English
  // string, using the table gEnglishMessagesTable.
***************
*** 286,289 ****
--- 308,312 ----
      return message;
  }
+ 
  
  // Returns a string containing a list of all possible error code and

Index: UnicodeConverter.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/UnicodeConverter.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** UnicodeConverter.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- UnicodeConverter.cpp	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File "UnicodeConverter.cpp"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "UnicodeConverter.cpp"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey

Index: UnicodeConverter.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/UnicodeConverter.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** UnicodeConverter.h	12 Feb 2006 22:56:33 -0000	1.3
--- UnicodeConverter.h	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File "UnicodeConverter.h"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "UnicodeConverter.h"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey

Index: main.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/main.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** main.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- main.cpp	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File "main.cpp"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "main.cpp"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
***************
*** 21,24 ****
--- 21,25 ----
  #include "BlahtexCore/Interface.h"
  #include "UnicodeConverter.h"
+ #include "mainPng.h"
  #include <iostream>
  #include <sstream>
***************
*** 28,32 ****
  using namespace blahtex;
  
! string gBlahtexVersion = "0.4.2";
  
  // A single global instance of UnicodeConverter.
--- 29,33 ----
  using namespace blahtex;
  
! string gBlahtexVersion = "0.4.4";
  
  // A single global instance of UnicodeConverter.
***************
*** 37,54 ****
  extern wstring GetErrorMessages();
  
- // Imported from mainPng.cpp:
- extern pair<string, int> MakePngFile(
-     const wstring& purifiedTex,
-     bool computeVerticalShift,
-     const string& tempDirectory,
-     const string& pngDirectory,
-     const string& shellLatex,
-     const string& shellDvips,
-     const string& shellConvert,
-     const string& imageMagickOptions,
-     bool deleteTempFiles
- );
- 
- 
  // FormatError() converts a blahtex Exception object into a string like
  // "<error><id>...</id><arg>...</arg><arg>...</arg> ...
--- 38,41 ----
***************
*** 87,185 ****
  "Usage: blahtex [ options ] < inputfile > outputfile\n"
  "\n"
! "INPUT OPTIONS\n"
  "\n"
  " --texvc-compatible-commands\n"
- "     recognise nonstandard texvc-specific commands\n"
- "\n"
- "MATHML OPTIONS\n"
  "\n"
  " --mathml\n"
- "     generate MathML output\n"
  " --indented\n"
! "     produce nicely indented MathML tags\n"
! "\n"
! " --spacing strict\n"
! "     emit MathML spacing markup wherever possible\n"
! " --spacing moderate (default)\n"
! "     emit spacing markup where a MathML renderer is likely to\n"
! "     have trouble\n"
! " --spacing relaxed\n"
! "     emit spacing markup only where specifically requested in\n"
! "     the TeX input\n"
! "\n"
  " --mathml-version-1-fonts\n"
- "     use character entities and MathML version 1 font attributes\n"
- "     instead of \"mathvariant\"\n"
- "\n"
  " --disallow-plane-1\n"
! "     force plane-1 MathML characters to be encoded as e.g. \"&Afr;\"\n"
! "     instead of e.g. \"&#x1d504;\"\n"
! "\n"
! " --mathml-encoding raw\n"
! "     encode non-ASCII MathML characters as raw UTF-8\n"
! " --mathml-encoding numeric (default)\n"
! "     encode non-ASCII MathML characters as numeric codes\n"
! "     (like \"&#x2191;\")\n"
! " --mathml-encoding short\n"
! "     encode non-ASCII MathML characters using short names\n"
! "     (like \"&uarr;\")\n"
! " --mathml-encoding long\n"
! "     encode non-ASCII MathML characters using long names\n"
! "     (like \"&UpArrow;\")\n"
! "\n"
! " --other-encoding raw\n"
! "     encode non-ASCII, non-MathML characters as raw UTF-8\n"
! " --other-encoding numeric (default)\n"
! "     encode non-ASCII, non-MathML characters as numeric codes\n"
! "\n"
! "PNG OPTIONS\n"
  "\n"
  " --png\n"
- "     generate PNG output\n"
- "\n"
  " --use-ucs-package\n"
! "     use the LaTeX ucs package to handle some non-ASCII characters\n"
! #ifdef BLAHTEX_USING_MAGICK
! "\n"
! " --compute-vertical-shift\n"
! "     determine the location of the baseline of the equation, and output\n"
! "     the number of pixels to shift (SOMEWHAT EXPERIMENTAL)\n"
! #endif
! "\n"
  " --shell-latex  command\n"
! " --shell-dvips  command\n"
! " --shell-convert  command\n"
! "     indicates commands for latex, dvips, ImageMagick utilities\n"
! "     (default is just \"latex\", \"dvips\", \"convert\")\n"
! "\n"
! " --convert-options  options-string\n"
! "     indicates options to be passed to ImageMagick convert utility\n"
! "     (default is:\n"
! "     -quality 100 -density 120 -matte -fill None -opaque White)\n"
! "\n"
  " --temp-directory  directory\n"
- "     which directory to use for temp files (.tex, .aux, .log, .dvi, .ps)\n"
- "     (default is current directory)\n"
  " --png-directory  directory\n"
- "     where to put the output PNG file\n"
- "     (default is current directory)\n"
- "\n"
- "DEBUGGING OPTIONS\n"
- "\n"
- " --debug parse\n"
- "     display the parse tree (output is NOT XML)\n"
- " --debug layout\n"
- "     display the layout tree (output is NOT XML)\n"
- " --debug purified\n"
- "     display purified TeX (output is NOT XML)\n"
  "\n"
  " --keep-temp-files\n"
- "     don't delete temporary files used during PNG generation\n"
- "\n"
  " --throw-logic-error\n"
- "     simulate a debug assertion occurring\n"
- "\n"
  " --print-error-messages\n"
- "     print a list of all the errors that blahtex can produce\n"
  "\n"
  "More information available at www.blahtex.org\n"
--- 74,102 ----
  "Usage: blahtex [ options ] < inputfile > outputfile\n"
  "\n"
! "SUMMARY OF OPTIONS (see manual for details)\n"
  "\n"
  " --texvc-compatible-commands\n"
  "\n"
  " --mathml\n"
  " --indented\n"
! " --spacing { strict | moderate | relaxed }\n"
  " --mathml-version-1-fonts\n"
  " --disallow-plane-1\n"
! " --mathml-encoding { raw | numeric | short | long }\n"
! " --other-encoding { raw | numeric }\n"
  "\n"
  " --png\n"
  " --use-ucs-package\n"
! " --use-cjk-package\n"
! " --japanese-font  fontname\n"
  " --shell-latex  command\n"
! " --shell-dvipng  command\n"
  " --temp-directory  directory\n"
  " --png-directory  directory\n"
  "\n"
+ " --debug { parse | layout | purified }\n"
  " --keep-temp-files\n"
  " --throw-logic-error\n"
  " --print-error-messages\n"
  "\n"
  "More information available at www.blahtex.org\n"
***************
*** 223,233 ****
          bool debugParseTree   = false;
          bool debugPurifiedTex = false;
!         bool deleteTempFiles = true;
  
          string shellLatex   = "latex";
!         string shellDvips   = "dvips";
!         string shellConvert = "convert";
!         string imageMagickOptions =
!             "-quality 100 -density 120 -matte -fill None -opaque White";
          string tempDirectory = "./";
          string  pngDirectory = "./";
--- 140,147 ----
          bool debugParseTree   = false;
          bool debugPurifiedTex = false;
!         bool deleteTempFiles  = true;
  
          string shellLatex   = "latex";
!         string shellDvipng  = "dvipng";
          string tempDirectory = "./";
          string  pngDirectory = "./";
***************
*** 260,288 ****
              }
  
!             else if (arg == "--shell-dvips")
!             {
!                 if (++i == argc)
!                     throw CommandLineException(
!                         "Missing string after \"--shell-dvips\""
!                     );
!                 shellDvips = string(argv[i]);
!             }
! 
!             else if (arg == "--shell-convert")
!             {
!                 if (++i == argc)
!                     throw CommandLineException(
!                         "Missing string after \"--shell-convert\""
!                     );
!                 shellConvert = string(argv[i]);
!             }
! 
!             else if (arg == "--convert-options")
              {
                  if (++i == argc)
                      throw CommandLineException(
!                         "Missing string after \"--convert-options\""
                      );
!                 imageMagickOptions = string(argv[i]);
              }
  
--- 174,184 ----
              }
  
!             else if (arg == "--shell-dvipng")
              {
                  if (++i == argc)
                      throw CommandLineException(
!                         "Missing string after \"--shell-dvipng\""
                      );
!                 shellDvipng = string(argv[i]);
              }
  
***************
*** 307,310 ****
--- 203,222 ----
              }
  
+             else if (arg == "--use-ucs-package")
+                 interface.mPurifiedTexOptions.mAllowUcs = true;
+ 
+             else if (arg == "--use-cjk-package")
+                 interface.mPurifiedTexOptions.mAllowCJK = true;
+             
+             else if (arg == "--japanese-font")
+             {
+                 if (++i == argc)
+                     throw CommandLineException(
+                         "Missing string after \"--japanese-font\""
+                     );
+                 interface.mPurifiedTexOptions.mJapaneseFont =
+                     gUnicodeConverter.ConvertIn(string(argv[i]));
+             }
+ 
              else if (arg == "--indented")
                  interface.mIndented = true;
***************
*** 336,341 ****
              }
  
-             else if (arg == "--use-ucs-package")
-                 interface.mPurifiedTexOptions.mUseUcsPackage = true;
  
              else if (arg == "--mathml-version-1-fonts")
--- 248,251 ----
***************
*** 348,356 ****
                  doPng = true;
  
- #ifdef BLAHTEX_USING_MAGICK
-             else if (arg == "--compute-vertical-shift")
-                 interface.mPurifiedTexOptions.mComputeVerticalShift = true;
- #endif
- 
              else if (arg == "--mathml")
                  doMathml = true;
--- 258,261 ----
***************
*** 508,530 ****
                      if (doPng)
                      {
!                         pair<string, int> pngData = MakePngFile(
                              purifiedTex,
-                             interface.mPurifiedTexOptions.
-                                 mComputeVerticalShift,
                              tempDirectory,
                              pngDirectory,
                              shellLatex,
!                             shellDvips,
!                             shellConvert,
!                             imageMagickOptions,
                              deleteTempFiles
                          );
  
!                         if (pngData.second != 1)
!                             pngOutput << L"<vshift>"
!                                 << pngData.second << L"</vshift>\n";
  
                          pngOutput << L"<md5>"
!                             << gUnicodeConverter.ConvertIn(pngData.first)
                              << L"</md5>\n";
                      }
--- 413,436 ----
                      if (doPng)
                      {
!                         PngInfo info = MakePngFile(
                              purifiedTex,
                              tempDirectory,
                              pngDirectory,
+                             "",
                              shellLatex,
!                             shellDvipng,
                              deleteTempFiles
                          );
  
!                         if (info.mDimensionsValid)
!                         {
!                             pngOutput << L"<height>"
!                                 << info.mHeight << L"</height>\n";
!                             pngOutput << L"<depth>"
!                                 << info.mDepth << L"</depth>\n";
!                         }
  
                          pngOutput << L"<md5>"
!                             << gUnicodeConverter.ConvertIn(info.mMd5)
                              << L"</md5>\n";
                      }
***************
*** 552,556 ****
                      mathmlOutput << L"<markup>\n";
                      mathmlOutput << interface.GetMathml();
!                     mathmlOutput << L"\n</markup>\n";
                  }
  
--- 458,464 ----
                      mathmlOutput << L"<markup>\n";
                      mathmlOutput << interface.GetMathml();
!                     if (!interface.mIndented)
!                         mathmlOutput << L"\n";
!                     mathmlOutput << L"</markup>\n";
                  }
  
***************
*** 596,600 ****
      catch (CommandLineException& e)
      {
!         cout << "Blahtex: " << e.mMessage << " (try \"blahtex --help\")\n";
      }
  
--- 504,508 ----
      catch (CommandLineException& e)
      {
!         cout << "blahtex: " << e.mMessage << " (try \"blahtex --help\")\n";
      }
  
***************
*** 603,607 ****
      catch (std::runtime_error& e)
      {
!         cout << "Blahtex runtime error: " << e.what() << endl;
      }
  
--- 511,515 ----
      catch (std::runtime_error& e)
      {
!         cout << "blahtex runtime error: " << e.what() << endl;
      }
  

Index: mainPng.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/mainPng.cpp,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** mainPng.cpp	12 Feb 2006 23:28:01 -0000	1.1
--- mainPng.cpp	14 Mar 2006 11:15:03 -0000	1.2
***************
*** 1,5 ****
  // File "mainPng.cpp"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "mainPng.cpp"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
***************
*** 19,32 ****
  // Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
  
- #ifdef BLAHTEX_USING_MAGICK
- #include <Magick++.h>
- #endif
- 
  #include "BlahtexCore/Misc.h"
  #include "UnicodeConverter.h"
  #include "md5Wrapper.h"
  #include <cerrno>
  #include <sys/stat.h>
- #include <string>
  #include <iostream>
  #include <fstream>
--- 19,28 ----
  // Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
  
  #include "BlahtexCore/Misc.h"
  #include "UnicodeConverter.h"
  #include "md5Wrapper.h"
+ #include "mainPng.h"
  #include <cerrno>
  #include <sys/stat.h>
  #include <iostream>
  #include <fstream>
***************
*** 97,101 ****
              throw blahtex::Exception(L"CannotChangeDirectory");
      }
! 
      bool result = (system(command.c_str()) == 0);
  
--- 93,97 ----
              throw blahtex::Exception(L"CannotChangeDirectory");
      }
!     
      bool result = (system(command.c_str()) == 0);
  
***************
*** 110,137 ****
  
  
! // Generates the PNG file, and computes vertical shift if requested.
! // Returns:
! //  * md5 of the UTF-8 version of the input.
! //  * vertical shift (a non-positive integer);
! //    or +1 if either the vertical shift was not requested, or if it
! //    could not be computed.
! pair<string, int> MakePngFile
! (
      const wstring& purifiedTex,
-     bool computeVerticalShift,
      const string& tempDirectory,
      const string& pngDirectory,
      const string& shellLatex,
!     const string& shellDvips,
!     const string& shellConvert,
!     const string& imageMagickOptions,
      bool deleteTempFiles
  )
  {
      string purifiedTexUtf8 = gUnicodeConverter.ConvertOut(purifiedTex);
! 
      string md5 = ComputeMd5(purifiedTexUtf8);
-     int shift = 1;
  
      {
          ofstream texFile(
--- 106,130 ----
  
  
! PngInfo MakePngFile(
      const wstring& purifiedTex,
      const string& tempDirectory,
      const string& pngDirectory,
+     const string& pngFilename,
      const string& shellLatex,
!     const string& shellDvipng,
      bool deleteTempFiles
  )
  {
+     PngInfo info;
+     
      string purifiedTexUtf8 = gUnicodeConverter.ConvertOut(purifiedTex);
!     
!     // This md5 is used for the temp filenames.
      string md5 = ComputeMd5(purifiedTexUtf8);
  
+     string pngActualFilename =
+         pngFilename.empty() ? (md5 + ".png") : pngFilename;
+ 
+     // Send output to tex file.
      {
          ofstream texFile(
***************
*** 150,168 ****
      }
  
!     // These are temporary files we want deleted
!     // when we're done.
!     TemporaryFile texTemp(tempDirectory + md5 + ".tex", deleteTempFiles);
!     TemporaryFile auxTemp(tempDirectory + md5 + ".aux", deleteTempFiles);
!     TemporaryFile logTemp(tempDirectory + md5 + ".log", deleteTempFiles);
!     TemporaryFile dviTemp(tempDirectory + md5 + ".dvi", deleteTempFiles);
!     TemporaryFile  psTemp(tempDirectory + md5 + ".ps", deleteTempFiles);
!     TemporaryFile psOriginalTemp(
!         tempDirectory + md5 + "-original.ps",
!         deleteTempFiles
!     );
  
-     // FIX: is the md5 hash enough here for the
-     // temporary file name? Should we also throw in a
-     // process ID, timestamp, or something?
  
      if (!Execute(
--- 143,153 ----
      }
  
!     // These are temporary files we want deleted when we're done.
!     TemporaryFile  texTemp(tempDirectory + md5 + ".tex",  deleteTempFiles);
!     TemporaryFile  auxTemp(tempDirectory + md5 + ".aux",  deleteTempFiles);
!     TemporaryFile  logTemp(tempDirectory + md5 + ".log",  deleteTempFiles);
!     TemporaryFile  dviTemp(tempDirectory + md5 + ".dvi",  deleteTempFiles);
!     TemporaryFile dataTemp(tempDirectory + md5 + ".data", deleteTempFiles);
  
  
      if (!Execute(
***************
*** 176,313 ****
          throw blahtex::Exception(L"CannotRunLatex");
  
      if (!Execute(
!         shellDvips + " -R -E " + tempDirectory + md5
!             + ".dvi -f -o " + tempDirectory + md5
!             + "-original.ps 2>/dev/null"
          )
          ||
!         !FileExists(tempDirectory + md5 + "-original.ps")
      )
!         throw blahtex::Exception(L"CannotRunDvips");
  
!     // Extend the PS file's bounding box to the right a few pixels. This
!     // addresses the unfortunate situation that can occur when dvips messes
!     // up the bounding box; for example, a single integral sign
!     // ("\displaystyle \int") gets chopped off.
      {
!         ifstream psInput(
!             (tempDirectory + md5 + "-original.ps").c_str(),
              ios::in | ios::binary
          );
- 
-         ofstream psOutput(
-             (tempDirectory + md5 + ".ps").c_str(),
-             ios::out | ios::binary
-         );
          
!         string line;
!         bool foundBoundingBox = false;
!         while (getline(psInput, line))
!         {
!             if (!foundBoundingBox && line.substr(0, 14) == "%%BoundingBox:")
!             {
!                 // Add 10 to the 3rd coordinate of the bounding box line
!                 foundBoundingBox = true;
!                 string half = line.substr(14, string::npos);
!                 istringstream decoder(half);
!                 int coord1, coord2, coord3, coord4;
!                 decoder >> coord1 >> coord2 >> coord3 >> coord4;
!                 ostringstream encoder;
!                 encoder << "%%BoundingBox: "
!                     << coord1 << " "
!                     << coord2 << " "
!                     << (coord3 + 10) << " "
!                     << coord4;
!                 line = encoder.str();
!             }
!             psOutput << line << endl;
!         }
!     }
! 
!     if (!Execute(
!         shellConvert + " " + imageMagickOptions
!             + " -trim " + tempDirectory + md5 + ".ps "
!             + pngDirectory + md5 + ".png "
!             + " >/dev/null 2>/dev/null"
!         )
!         ||
!         !FileExists(pngDirectory + md5 + ".png")
!     )
!         throw blahtex::Exception(L"CannotRunConvert");
! 
! #ifdef BLAHTEX_USING_MAGICK
!     if (computeVerticalShift)
!     {
!         try     // for Magick exceptions
          {
!             Magick::Image image(
!                 pngDirectory + md5 + ".png"
!             );
!             
!             unsigned width = image.baseColumns();
!             unsigned height = image.baseRows();
! 
!             // In Manager::GeneratePurifiedTex() we
!             // arranged for the PNG to have an extra
!             // pixel located on the baseline of the
!             // equation. Now we search for that pixel.
!             int row;
!             Magick::Pixels view(image);
!             Magick::PixelPacket* pixels = view.get(0, 0, 1, height);
!             for (row = 0; row < height; ++row, ++pixels)
!                 if (pixels->red)
!                     break;
! 
!             if (row < height)
              {
!                 // Found it.
!                 shift = row - height + 1;
! 
!                 // Remove the first column of the image.
!                 
!                 // FIX: I wanted to use the ImageMagick crop function, but
!                 // it seemed really buggy; it didn't seem to respect the
!                 // desired crop region accurately enough. So instead we just
!                 // create a new image from scratch and copy the pixels
!                 // across, one at a time.
!                 
!                 if (width >= 2)
                  {
!                     Magick::Image newImage(
!                         Magick::Geometry(width - 2, height),
!                         Magick::Color(0, 0, 0, 0)
!                     );
!                     
!                     newImage.modifyImage();
!                     
!                     Magick::Pixels newView(newImage);
!                     
!                     Magick::PixelPacket* pixels =
!                         view.get(2, 0, width - 2, height);
! 
!                     Magick::PixelPacket* newPixels =
!                         newView.get(0, 0, width - 2, height);
!                     
!                     for (unsigned k = (width - 2) * height; k > 0; --k)
!                         *newPixels++ = *pixels++;
!                     
!                     newView.sync();
!                     
!                     if (!deleteTempFiles)
!                         image.write(tempDirectory + md5 + "-original.png");
! 
!                     newImage.write(pngDirectory + md5 + ".png");
                  }
              }
          }
-         catch (Magick::Exception& e)
-         {
-             // If imagemagick produces any exceptions,
-             // we just ignore it and give up on the
-             // vertical alignment stuff.
-         }
      }
- #endif
  
!     return make_pair(md5, shift);
  }
--- 161,214 ----
          throw blahtex::Exception(L"CannotRunLatex");
  
+ 
      if (!Execute(
!             shellDvipng + " " + md5 + ".dvi " +
!                 "--picky --bg Transparent --gamma 1.3 -D 120 -q " +
!                 "--height --depth " +
!                 "-o \"" + pngActualFilename +
!                 "\" > " + md5 + ".data 2>/dev/null", 
!             tempDirectory
          )
          ||
!         !FileExists(tempDirectory + pngActualFilename)
      )
!         throw blahtex::Exception(L"CannotRunDvipng");
!         
!     if (rename(
!         (tempDirectory + pngActualFilename).c_str(),
!         (pngDirectory + pngActualFilename).c_str()
!     ))
!         throw blahtex::Exception(L"CannotWritePngDirectory");
  
! 
!     // Read the height and depth of the image from dvipng's output.
      {
!         ifstream dataFile(
!             (tempDirectory + md5 + ".data").c_str(),
              ios::in | ios::binary
          );
          
!         if (dataFile)
          {
!             string line, temp;
!             while (getline(dataFile, line))
              {
!                 string::size_type heightPos = line.find("height=");
!                 string::size_type depthPos = line.find("depth=");
!                 if (heightPos != string::npos && depthPos != string::npos)
                  {
!                     info.mDimensionsValid = true;
!                     temp = line.substr(heightPos + 7, 1000);
!                     istringstream(temp) >> info.mHeight;
!                     string temp = line.substr(depthPos + 6, 1000);
!                     istringstream(temp) >> info.mDepth;
                  }
              }
          }
      }
  
!     info.mMd5 = md5;
!     return info;
  }
+ 
+ // end of file @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Index: md5.c
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4

Index: md5.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4

Index: md5Wrapper.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5Wrapper.cpp,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** md5Wrapper.cpp	12 Feb 2006 22:56:33 -0000	1.3
--- md5Wrapper.cpp	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File "md5Wrapper.cpp"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "md5Wrapper.cpp"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey

Index: md5Wrapper.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5Wrapper.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** md5Wrapper.h	12 Feb 2006 22:56:33 -0000	1.3
--- md5Wrapper.h	14 Mar 2006 11:15:03 -0000	1.4
***************
*** 1,5 ****
  // File "md5Wrapper.h"
  //
! // blahtex (version 0.4.2)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey
--- 1,5 ----
  // File "md5Wrapper.h"
  //
! // blahtex (version 0.4.4)
  // a TeX to MathML converter designed with MediaWiki in mind
  // Copyright (C) 2006, David Harvey



From nobody at sheep.berlios.de  Tue Mar 14 13:25:24 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Tue, 14 Mar 2006 13:25:24 +0100
Subject: [Blahtex-cvs] blahtex/includes DefaultSettings.php,1.13,1.14
Message-ID: <200603141225.k2ECPOb07085@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv6989

Modified Files:
	DefaultSettings.php 
Log Message:
Bump blahtex version.


Index: DefaultSettings.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/DefaultSettings.php,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** DefaultSettings.php	14 Feb 2006 23:50:43 -0000	1.13
--- DefaultSettings.php	14 Mar 2006 11:26:44 -0000	1.14
***************
*** 32,36 ****
  
  /** MediaWiki version number */
! $wgVersion			= '1.5.5 + blahtex 0.4.2';
  
  /** Name of the site. It must be changed in LocalSettings.php */
--- 32,36 ----
  
  /** MediaWiki version number */
! $wgVersion			= '1.5.5 + blahtex 0.4.4 (preview)';
  
  /** Name of the site. It must be changed in LocalSettings.php */



From nobody at sheep.berlios.de  Tue Mar 14 14:23:15 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Tue, 14 Mar 2006 14:23:15 +0100
Subject: [Blahtex-cvs] blahtex/includes Math.php,1.24,1.25
Message-ID: <200603141323.k2EDNFb12475@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv6697

Modified Files:
	Math.php 
Log Message:
Add new options for blahtex 0.4.4


Index: Math.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Math.php,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** Math.php	14 Feb 2006 23:54:03 -0000	1.24
--- Math.php	14 Mar 2006 12:24:32 -0000	1.25
***************
*** 210,214 ****
  	function invokeTexvc($tex)
  	{
! 	        global $wgMathDirectory, $wgTmpDirectory, $wgTexvc, $wgInputEncoding;
  
  		$cmd = $wgTexvc . ' ' . 
--- 210,214 ----
  	function invokeTexvc($tex)
  	{
! 		global $wgMathDirectory, $wgTmpDirectory, $wgTexvc, $wgInputEncoding;
  
  		$cmd = $wgTexvc . ' ' . 
***************
*** 234,242 ****
  	}
  
!         /**
  	 * Process texvc output and fill the mathml, html, hash, and conservativeness fields.
  	 * Returns an error message, or false if no error occurred.
  	 */
!         function processTexvcOutput($contents) {
  		global $wgMathDirectory;
  
--- 234,242 ----
  	}
  
! 	/**
  	 * Process texvc output and fill the mathml, html, hash, and conservativeness fields.
  	 * Returns an error message, or false if no error occurred.
  	 */
! 	function processTexvcOutput($contents) {
  		global $wgMathDirectory;
  
***************
*** 308,339 ****
                  $descriptorspec = array(0 => array("pipe", "r"),
                                          1 => array("pipe", "w"));
! 		$options = '--mathml --texvc-compatible-commands --mathml-version-1-fonts --disallow-plane-1 --use-ucs-package --spacing strict';
! 		if ($makePNG)
! 			$options = "$options --png --temp-directory $wgTmpDirectory --png-directory $wgMathDirectory";
! 			global $wgUseBlahtexVerticalShift;
! 			if ( $wgUseBlahtexVerticalShift )
! 				$options .= " --compute-vertical-shift";
!                 $process = proc_open($wgBlahtex.' '.$options, $descriptorspec, $pipes);
!                 if (!$process) {
  			return array(false, $this->_error('math_unknown_error', ' #1'));
!                 }
  		fwrite($pipes[0], '\\displaystyle ');
!                 fwrite($pipes[0], $tex);
!                 fclose($pipes[0]);
! 
!                 $contents = '';
!                 while (!feof($pipes[1])) {
  			$contents .= fgets($pipes[1], 4096);
!                 }
!                 fclose($pipes[1]);
!                 if (proc_close($process) != 0) {
  			// exit code of blahtex is not zero; this shouldn't happen
  			return array(false, $this->_error('math_unknown_error', ' #2'));
!                 }
! 
  		return array(true, $contents);
  	}
  
!         /**
  	 * Process blahtex output and update the mathml and png fields.
  	 * Returns an error message, or false if no error occurred.
--- 308,343 ----
                  $descriptorspec = array(0 => array("pipe", "r"),
                                          1 => array("pipe", "w"));
! 		$options = '--mathml --texvc-compatible-commands --mathml-version-1-fonts --disallow-plane-1 --spacing strict';
! 		if ($makePNG) {
! 			$options .= " --png --temp-directory $wgTmpDirectory --png-directory $wgMathDirectory";
! 			$options .= " --use-ucs-package --use-cjk-package --japanese-font ipam";
! 		}
! 
! 		global $wgUseBlahtexVerticalShift;
! 		if ( $wgUseBlahtexVerticalShift )
! 			$options .= " --compute-vertical-shift";
! 
! 		$process = proc_open($wgBlahtex.' '.$options, $descriptorspec, $pipes);
! 		if (!$process) {
  			return array(false, $this->_error('math_unknown_error', ' #1'));
! 		}
  		fwrite($pipes[0], '\\displaystyle ');
! 		fwrite($pipes[0], $tex);
! 		fclose($pipes[0]);
! 		
! 		$contents = '';
! 		while (!feof($pipes[1])) {
  			$contents .= fgets($pipes[1], 4096);
! 		}
! 		fclose($pipes[1]);
! 		if (proc_close($process) != 0) {
  			// exit code of blahtex is not zero; this shouldn't happen
  			return array(false, $this->_error('math_unknown_error', ' #2'));
! 		}
! 		
  		return array(true, $contents);
  	}
  
! 	/**
  	 * Process blahtex output and update the mathml and png fields.
  	 * Returns an error message, or false if no error occurred.
***************
*** 342,346 ****
  	function processBlahtexOutput($results)
  	{
! 	        if (isset($results["blahtex:logicError"])) {
  			// Case I: Something went completely wrong
  			return $this->_error('math_unknown_error', $results["blahtex:logicError"]);
--- 346,350 ----
  	function processBlahtexOutput($results)
  	{
! 		if (isset($results["blahtex:logicError"])) {
  			// Case I: Something went completely wrong
  			return $this->_error('math_unknown_error', $results["blahtex:logicError"]);



From nobody at sheep.berlios.de  Sun Mar 19 07:40:30 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 19 Mar 2006 07:40:30 +0100
Subject: [Blahtex-cvs] blahtex/blahtex/source main.cpp,1.4,1.5 mainPng.cpp,1.2,1.3 md5.c,1.4,1.5 md5.h,1.4,1.5
Message-ID: <200603190640.k2J6eUb16413@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex/source
In directory sheep:/tmp/cvs-serv7335/source

Modified Files:
	main.cpp mainPng.cpp md5.c md5.h 
Log Message:
Update to blahtex-0.4.4-pre2


Index: main.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/main.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** main.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- main.cpp	19 Mar 2006 05:41:46 -0000	1.5
***************
*** 89,92 ****
--- 89,93 ----
  " --use-ucs-package\n"
  " --use-cjk-package\n"
+ " --use-preview-package\n"
  " --japanese-font  fontname\n"
  " --shell-latex  command\n"
***************
*** 209,212 ****
--- 210,216 ----
                  interface.mPurifiedTexOptions.mAllowCJK = true;
              
+             else if (arg == "--use-preview-package")
+                 interface.mPurifiedTexOptions.mAllowPreview = true;
+             
              else if (arg == "--japanese-font")
              {
***************
*** 248,252 ****
              }
  
- 
              else if (arg == "--mathml-version-1-fonts")
                  interface.mMathmlOptions.mUseVersion1FontAttributes = true;
--- 252,255 ----
***************
*** 423,427 ****
                          );
  
!                         if (info.mDimensionsValid)
                          {
                              pngOutput << L"<height>"
--- 426,434 ----
                          );
  
!                         // The height and depth measurements are only
!                         // valid if the "preview" package is used:
!                         if (interface.mPurifiedTexOptions.mAllowPreview
!                             && info.mDimensionsValid
!                         )
                          {
                              pngOutput << L"<height>"

Index: mainPng.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/mainPng.cpp,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** mainPng.cpp	14 Mar 2006 11:15:03 -0000	1.2
--- mainPng.cpp	19 Mar 2006 05:41:46 -0000	1.3
***************
*** 152,157 ****
  
      if (!Execute(
!             shellLatex + " " + md5
!                 + ".tex >/dev/null 2>/dev/null",
              tempDirectory
          )
--- 152,156 ----
  
      if (!Execute(
!             shellLatex + " " + md5 + ".tex >/dev/null 2>/dev/null",
              tempDirectory
          )
***************
*** 164,168 ****
      if (!Execute(
              shellDvipng + " " + md5 + ".dvi " +
!                 "--picky --bg Transparent --gamma 1.3 -D 120 -q " +
                  "--height --depth " +
                  "-o \"" + pngActualFilename +
--- 163,167 ----
      if (!Execute(
              shellDvipng + " " + md5 + ".dvi " +
!                 "--picky --bg Transparent --gamma 1.3 -D 120 -q -T tight " +
                  "--height --depth " +
                  "-o \"" + pngActualFilename +

Index: md5.c
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5

Index: md5.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5



From nobody at sheep.berlios.de  Sun Mar 19 07:40:32 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 19 Mar 2006 07:40:32 +0100
Subject: [Blahtex-cvs] blahtex/blahtex/source/BlahtexCore Manager.cpp,1.4,1.5 Misc.h,1.4,1.5
Message-ID: <200603190640.k2J6eWb16417@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore
In directory sheep:/tmp/cvs-serv7335/source/BlahtexCore

Modified Files:
	Manager.cpp Misc.h 
Log Message:
Update to blahtex-0.4.4-pre2


Index: Manager.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/Manager.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** Manager.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- Manager.cpp	19 Mar 2006 05:41:51 -0000	1.5
***************
*** 529,539 ****
      }
  
!     output << L"\\usepackage[active]{preview}\n";
      output << L"\\begin{document}\n";
!     output << L"\\begin{preview}\n";
      output << L"$\n" << latex << L"\n$\n";
!     output << L"\\end{preview}\n";
      output << L"\\end{document}\n";
!     
      return output.str();
  }
--- 529,549 ----
      }
  
!     if (options.mAllowPreview)
!         output << L"\\usepackage[active]{preview}\n";
!     else
!         output << L"\\pagestyle{empty}\n";
!         
      output << L"\\begin{document}\n";
! 
!     if (options.mAllowPreview)
!         output << L"\\begin{preview}\n";
!     
      output << L"$\n" << latex << L"\n$\n";
! 
!     if (options.mAllowPreview)
!         output << L"\\end{preview}\n";
! 
      output << L"\\end{document}\n";
! 
      return output.str();
  }

Index: Misc.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/Misc.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** Misc.h	14 Mar 2006 11:15:03 -0000	1.4
--- Misc.h	19 Mar 2006 05:41:51 -0000	1.5
***************
*** 202,205 ****
--- 202,208 ----
      bool mAllowCJK;
      
+     // Blahtex may use the "preview" package.
+     bool mAllowPreview;
+     
      // The font name (e.g. "ipam") which gets passed to "\begin{CJK}..."
      // for handling japanese, or blank if no font is available.
***************
*** 208,212 ****
      PurifiedTexOptions() :
          mAllowUcs(false),
!         mAllowCJK(false)
      { }
  };
--- 211,216 ----
      PurifiedTexOptions() :
          mAllowUcs(false),
!         mAllowCJK(false),
!         mAllowPreview(false)
      { }
  };



From nobody at sheep.berlios.de  Sun Mar 19 07:41:34 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 19 Mar 2006 07:41:34 +0100
Subject: [Blahtex-cvs] blahtex/includes DefaultSettings.php,1.14,1.15
Message-ID: <200603190641.k2J6fYb16467@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv7714/includes

Modified Files:
	DefaultSettings.php 
Log Message:
Bump blahtex version.


Index: DefaultSettings.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/DefaultSettings.php,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** DefaultSettings.php	14 Mar 2006 11:26:44 -0000	1.14
--- DefaultSettings.php	19 Mar 2006 05:42:50 -0000	1.15
***************
*** 32,36 ****
  
  /** MediaWiki version number */
! $wgVersion			= '1.5.5 + blahtex 0.4.4 (preview)';
  
  /** Name of the site. It must be changed in LocalSettings.php */
--- 32,36 ----
  
  /** MediaWiki version number */
! $wgVersion			= '1.5.5 + blahtex 0.4.4-pre2';
  
  /** Name of the site. It must be changed in LocalSettings.php */



From nobody at sheep.berlios.de  Thu Mar 23 11:40:35 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:35 +0100
Subject: [Blahtex-cvs] blahtex/skins/common/images redirect.png,1.1.1.1,NONE
Message-ID: <200603231040.k2NAeZt01182@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/skins/common/images
In directory sheep:/tmp/cvs-serv25749/skins/common/images

Removed Files:
	redirect.png 
Log Message:
Import of MediaWiki CVS from vendor branch

--- redirect.png DELETED ---



From nobody at sheep.berlios.de  Thu Mar 23 11:40:35 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:35 +0100
Subject: [Blahtex-cvs] blahtex/maintenance recount.sql,1.2,1.3 convertUtf8.php,1.1.1.1,NONE dumpRev.php,1.1.1.1,NONE removeUnusedAccounts.inc,1.1.1.1,NONE
Message-ID: <200603231040.k2NAeZt01173@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/maintenance
In directory sheep:/tmp/cvs-serv25749/maintenance

Added Files:
	recount.sql 
Removed Files:
	convertUtf8.php dumpRev.php removeUnusedAccounts.inc 
Log Message:
Import of MediaWiki CVS from vendor branch


--- convertUtf8.php DELETED ---

--- dumpRev.php DELETED ---

--- removeUnusedAccounts.inc DELETED ---



From nobody at sheep.berlios.de  Thu Mar 23 11:40:34 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:34 +0100
Subject: [Blahtex-cvs] blahtex/languages Language.php,1.11,1.12 Messages.php,1.1.1.1,1.2 LanguageGem_alsatian.php,1.1.1.2,NONE
Message-ID: <200603231040.k2NAeYt01168@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/languages
In directory sheep:/tmp/cvs-serv25749/languages

Modified Files:
	Language.php Messages.php 
Removed Files:
	LanguageGem_alsatian.php 
Log Message:
Import of MediaWiki CVS from vendor branch

Index: Language.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/languages/Language.php,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** Language.php	30 Jan 2006 00:33:56 -0000	1.11
--- Language.php	23 Mar 2006 10:40:58 -0000	1.12
***************
*** 82,85 ****
--- 82,88 ----
  	'externaleditor' 	=> 0,
  	'externaldiff' 		=> 0,
+ 	'showjumplinks'		=> 1,
+ 	'numberheadings'	=> 0,
+ 	'uselivepreview'	=> 0,
  );
  
***************
*** 108,117 ****
[...2425 lines suppressed...]
+ 		return $this->mConverter->parserConvert( $text, $parser );
+ 	}
+ 
  	/**
  	 * Perform output conversion on a string, and encode for safe HTML output.
***************
*** 2955,2960 ****
--- 1146,1157 ----
  }
  
+ # FIXME: Merge all UTF-8 support code into Language base class.
+ # We no longer support Latin-1 charset.
+ require_once( 'LanguageUtf8.php' );
+ 
  # This should fail gracefully if there's not a localization available
  wfSuppressWarnings();
+ // Preload base classes to work around APC/PHP5 bug
+ include_once( 'Language' . str_replace( '-', '_', ucfirst( $wgLanguageCode ) ) . '.deps.php' );
  include_once( 'Language' . str_replace( '-', '_', ucfirst( $wgLanguageCode ) ) . '.php' );
  wfRestoreWarnings();

Index: Messages.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/languages/Messages.php,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** Messages.php	23 Mar 2006 10:12:20 -0000	1.1.1.1
--- Messages.php	23 Mar 2006 10:40:58 -0000	1.2
***************
*** 675,687 ****
  'datedefault'		=> 'No preference',
  'datetime'		=> 'Date and time',
- 'math_failure'		=> 'Failed to parse',
- 'math_unknown_error'	=> 'unknown error',
- 'math_unknown_function'	=> 'unknown function',
- 'math_lexing_error'	=> 'lexing error',
- 'math_syntax_error'	=> 'syntax error',
- 'math_image_error'	=> 'PNG conversion failed; check for correct installation of latex, dvips, gs, and convert',
- 'math_bad_tmpdir'	=> 'Can\'t write to or create math temp directory',
- 'math_bad_output'	=> 'Can\'t write to or create math output directory',
- 'math_notexvc'	=> 'Missing texvc executable; please see math/README to configure.',
  'prefs-personal' => 'User profile',
  'prefs-rc' => 'Recent changes',
--- 675,678 ----
***************
*** 712,715 ****
--- 703,781 ----
  'default'		=> 'default',
  'files'			=> 'Files',
+ 
+ # Mathematics
+ #
+ 
+ 'math_failure'		=> 'Failed to parse',
+ 'math_unknown_error'	=> 'unknown error$1',
+ 'math_unknown_function'	=> 'unknown function ',
+ 'math_input_error'	=> 'input error',
+ 'math_lexing_error'	=> 'lexing error $1',
+ 'math_syntax_error'	=> 'syntax error $1',
+ 'math_image_error'	=> 'PNG conversion failed; check for correct installation of latex, dvips, gs, and convert',
+ 'math_bad_tmpdir'	=> 'Can\'t write to or create math temp directory',
+ 'math_bad_output'	=> 'Can\'t write to or create math output directory',
+ 'math_notexvc'	        => 'Missing texvc executable; please see math/README to configure.',
+ 'math_noblahtex'        => 'Can\'t execute blahtex, which should be at $1',
+ 
+ 'math_NonAsciiInMathMode'               => 'Non-ASCII characters may only be used in text mode ' .
+                                            '(try enclosing the problem characters in "\\text{...}")',
+ 'math_IllegalCharacter'                 => 'Illegal character in input',
+ 'math_PngIncompatibleCharacter'         => 'Unable to correctly generate PNG containing the character $1',
+ 'math_ReservedCommand'                  => 'The command "$1" is reserved for internal use by blahtex',
+ 'math_TooManyTokens'                    => 'The input is too long',
+ 'math_IllegalFinalBackslash'            => 'Illegal backslash "\\" at end of input',
+ 'math_UnrecognisedCommand'              => 'Unrecognised command "$1"',
+ 'math_IllegalCommandInMathMode'         => 'The command "$1" is illegal in math mode',
+ 'math_IllegalCommandInMathModeWithHint' => 'The command "$1" is illegal in math mode ' .
+                                            '(perhaps you intended to use "$2" instead?)',
+ 'math_IllegalCommandInTextMode'         => 'The command "$1" is illegal in text mode',
+ 'math_IllegalCommandInTextModeWithHint' => 'The command "$1" is illegal in text mode ' .
+                                            '(perhaps you intended to use "$2" instead?)',
+ 'math_MissingOpenBraceBefore'           => 'Missing open brace "{" before "$1"',
+ 'math_MissingOpenBraceAfter'            => 'Missing open brace "{" after "$1"',
+ 'math_MissingOpenBraceAtEnd'            => 'Missing open brace "{" at end of input',
+ 'math_NotEnoughArguments'               => 'Not enough arguments were supplied for "$1"',
+ 'math_MissingCommandAfterNewcommand'    => 'Missing or illegal new command name after "\\newcommand" ' .
+                                            '(there must be precisely one command defined; it must begin ' .
+                                            'with a backslash "\\" and contain only alphabetic characters)',
+ 'math_IllegalRedefinition'              => 'The command "$1" has already been defined; you cannot redefine it',
+ 'math_MissingOrIllegalParameterCount'   => 'Missing or illegal parameter count in definition of "$1" ' .
+                                            '(must be a single digit between 1 and 9 inclusive)',
+ 'math_MissingOrIllegalParameterIndex'   => 'Missing or illegal parameter index in definition of "$1"',
+ 'math_UnmatchedOpenBracket'             => 'Encountered open bracket "[" without matching close bracket "]"',
+ 'math_UnmatchedOpenBrace'               => 'Encountered open brace "{" without matching close brace "}"',
+ 'math_UnmatchedCloseBrace'              => 'Encountered close brace "}" without matching open brace "{"',
+ 'math_UnmatchedLeft'                    => 'Encountered "\\left" without matching "\\right"',
+ 'math_UnmatchedRight'                   => 'Encountered "\\right" without matching "\\left"',
+ 'math_UnmatchedBegin'                   => 'Encountered "\\begin" without matching "\\end"',
+ 'math_UnmatchedEnd'                     => 'Encountered "\\end" without matching "\\begin"',
+ 'math_UnexpectedNextCell'               => 'The command "&" may only appear inside a "\\begin ... \\end" block',
+ 'math_UnexpectedNextRow'                => 'The command "\\\\" may only appear inside a "\\begin ... \\end" block',
+ 'math_MismatchedBeginAndEnd'            => 'Commands "$1" and "$2" do not match',
+ 'math_CasesRowTooBig'                   => 'There can only be two entries in each row of a "cases" block',
+ 'math_MissingDelimiter'                 => 'Missing delimiter after "$1"',
+ 'math_IllegalDelimiter'                 => 'Illegal delimiter following "$1"',
+ 'math_MisplacedLimits'                  => 'The command "$1" can only appear after a math operator ' .
+                                            '(consider using "\\mathop")',
+ 'math_DoubleSuperscript'                => 'Encountered two superscripts attached to the same base ' .
+                                            '(only one is allowed)',
+ 'math_DoubleSubscript'                  => 'Encountered two subscripts attached to the same base ' . 
+                                            '(only one is allowed)',
+ 'math_AmbiguousInfix'                   => 'Ambiguous placement of "$1" ' . 
+                                            '(try using additional braces "{ ... }" to disambiguate)',
+ 'math_UnavailableSymbolFontCombination' => 'The symbol "$1" is not available in the font "$2"',
+ 'math_InvalidNegation'                  => 'No negative version of the symbol(s) following "\\not" is available',
+ 'math_SubstackRowTooBig'                => 'There can only be one entry in each row of a "substack" block',
+ 
+ 'math_TooManyMathmlNodes'               => 'There are too many nodes in the MathML tree',
+ 
+ 'math_InvalidUtf8Input'                 => 'The input string was not valid UTF-8',
+ 'math_CannotCreateTexFile'              => 'Cannot create tex file',
+ 'math_CannotWriteTexFile'               => 'Cannot write to tex file',
+ 'math_CannotRunLatex'                   => 'Cannot run latex',
+ 'math_CannotRunDvips'                   => 'Cannot run dvips',
+ 'math_CannotRunConvert'                 => 'Cannot run convert',
+ 'math_CannotChangeDirectory'            => 'Cannot change working directory',
  
  # User levels special page

--- LanguageGem_alsatian.php DELETED ---



From nobody at sheep.berlios.de  Thu Mar 23 11:40:36 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:36 +0100
Subject: [Blahtex-cvs] blahtex/tests SearchMySQL3Test.php,1.1.1.1,NONE
Message-ID: <200603231040.k2NAeat01190@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/tests
In directory sheep:/tmp/cvs-serv25749/tests

Removed Files:
	SearchMySQL3Test.php 
Log Message:
Import of MediaWiki CVS from vendor branch

--- SearchMySQL3Test.php DELETED ---



From nobody at sheep.berlios.de  Thu Mar 23 11:40:35 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:35 +0100
Subject: [Blahtex-cvs] blahtex/maintenance/mysql5 tables.sql,1.1.1.1,NONE
Message-ID: <200603231040.k2NAeZt01175@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/maintenance/mysql5
In directory sheep:/tmp/cvs-serv25749/maintenance/mysql5

Removed Files:
	tables.sql 
Log Message:
Import of MediaWiki CVS from vendor branch

--- tables.sql DELETED ---



From nobody at sheep.berlios.de  Thu Mar 23 11:40:35 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:35 +0100
Subject: [Blahtex-cvs] blahtex/skins MonoBook.php,1.3,1.4
Message-ID: <200603231040.k2NAeZt01178@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/skins
In directory sheep:/tmp/cvs-serv25749/skins

Modified Files:
	MonoBook.php 
Log Message:
Import of MediaWiki CVS from vendor branch

Index: MonoBook.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/skins/MonoBook.php,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** MonoBook.php	4 Dec 2005 17:16:32 -0000	1.3
--- MonoBook.php	23 Mar 2006 10:40:59 -0000	1.4
***************
*** 12,16 ****
  
  if( !defined( 'MEDIAWIKI' ) )
! 	die();
  
  /** */
--- 12,16 ----
  
  if( !defined( 'MEDIAWIKI' ) )
! 	die( -1 );
  
  /** */
***************
*** 55,227 ****
             "<?php $this->text('dtd'); ?>">
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php $this->text('lang') ?>" lang="<?php $this->text('lang') ?>" dir="<?php $this->text('dir') ?>">
!   <head>
!     <meta http-equiv="Content-Type" content="<?php $this->text('mimetype') ?>; charset=<?php $this->text('charset') ?>" />
!     <?php $this->html('headlinks') ?>
!     <title><?php $this->text('pagetitle') ?></title>
!     <style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/main.css"; /*]]>*/</style>
!     <link rel="stylesheet" type="text/css" <?php if(empty($this->data['printable']) ) { ?>media="print"<?php } ?> href="<?php $this->text('stylepath') ?>/common/commonPrint.css" />
!     <!--[if lt IE 5.5000]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE50Fixes.css";</style><![endif]-->
!     <!--[if IE 5.5000]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE55Fixes.css";</style><![endif]-->
!     <!--[if gte IE 6]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE60Fixes.css";</style><![endif]-->
!     <!--[if IE]><script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('stylepath') ?>/common/IEFixes.js"></script>
!     <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
!     <?php if($this->data['jsvarurl'  ]) { ?><script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('jsvarurl'  ) ?>"></script><?php } ?>
!     <script type="<?php $this->text('jsmimetype') ?>" src="<?php                                   $this->text('stylepath' ) ?>/common/wikibits.js"></script>
!     <?php if($this->data['usercss'   ]) { ?><style type="text/css"><?php              $this->html('usercss'   ) ?></style><?php    } ?>
!     <?php if($this->data['userjs'    ]) { ?><script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('userjs'    ) ?>"></script><?php } ?>
!     <?php if($this->data['userjsprev']) { ?><script type="<?php $this->text('jsmimetype') ?>"><?php      $this->html('userjsprev') ?></script><?php   } ?>
!     <?php if($this->data['trackbackhtml']) print $this->data['trackbackhtml']; ?>
!   </head>
!   <body <?php if($this->data['body_ondblclick']) { ?>ondblclick="<?php $this->text('body_ondblclick') ?>"<?php } ?>
!         <?php if($this->data['body_onload'    ]) { ?>onload="<?php     $this->text('body_onload')     ?>"<?php } ?>
!         <?php if($this->data['nsclass'        ]) { ?>class="<?php      $this->text('nsclass')         ?>"<?php } ?>>
!     <div id="globalWrapper">
!       <div id="column-content">
  	<div id="content">
! 	  <a name="top" id="top"></a>
! 	  <?php if($this->data['sitenotice']) { ?><div id="siteNotice"><?php $this->html('sitenotice') ?></div><?php } ?>
! 	  <h1 class="firstHeading"><?php $this->text('title') ?></h1>
! 	  <div id="bodyContent">
! 	    <h3 id="siteSub"><?php $this->msg('tagline') ?></h3>
! 	    <div id="contentSub"><?php $this->html('subtitle') ?></div>
! 	    <?php if($this->data['undelete']) { ?><div id="contentSub"><?php     $this->html('undelete') ?></div><?php } ?>
! 	    <?php if($this->data['newtalk'] ) { ?><div class="usermessage"><?php $this->html('newtalk')  ?></div><?php } ?>
! 	    <!-- start content -->
! 	    <?php $this->html('bodytext') ?>
! 	    <?php if($this->data['catlinks']) { ?><div id="catlinks"><?php       $this->html('catlinks') ?></div><?php } ?>
! 	    <!-- end content -->
! 	    <div class="visualClear"></div>
! 	  </div>
  	</div>
!       </div>
!       <div id="column-one">
  	<div id="p-cactions" class="portlet">
! 	  <h5><?php $this->msg('views') ?></h5>
! 	  <ul>
! 	    <?php foreach($this->data['content_actions'] as $key => $action) {
! 	       ?><li id="ca-<?php echo htmlspecialchars($key) ?>"
! 	       <?php if($action['class']) { ?>class="<?php echo htmlspecialchars($action['class']) ?>"<?php } ?>
! 	       ><a href="<?php echo htmlspecialchars($action['href']) ?>"><?php
! 	       echo htmlspecialchars($action['text']) ?></a></li><?php
! 	     } ?>
! 	  </ul>
  	</div>
  	<div class="portlet" id="p-personal">
! 	  <h5><?php $this->msg('personaltools') ?></h5>
! 	  <div class="pBody">
! 	    <ul>
! 	    <?php foreach($this->data['personal_urls'] as $key => $item) {
! 	       ?><li id="pt-<?php echo htmlspecialchars($key) ?>"><a href="<?php
! 	       echo htmlspecialchars($item['href']) ?>"<?php
! 	       if(!empty($item['class'])) { ?> class="<?php
! 	       echo htmlspecialchars($item['class']) ?>"<?php } ?>><?php
! 	       echo htmlspecialchars($item['text']) ?></a></li><?php
! 	    } ?>
! 	    </ul>
! 	  </div>
  	</div>
  	<div class="portlet" id="p-logo">
! 	  <a style="background-image: url(<?php $this->text('logopath') ?>);"
! 	    href="<?php echo htmlspecialchars($this->data['nav_urls']['mainpage']['href'])?>"
! 	    title="<?php $this->msg('mainpage') ?>"></a>
  	</div>
  	<script type="<?php $this->text('jsmimetype') ?>"> if (window.isMSIE55) fixalpha(); </script>
  	<?php foreach ($this->data['sidebar'] as $bar => $cont) { ?>
  	<div class='portlet' id='p-<?php echo htmlspecialchars($bar) ?>'>
! 	  <h5><?php $out = wfMsg( $bar ); if (wfNoMsg($bar, $out)) echo $bar; else echo $out; ?></h5>
! 	  <div class='pBody'>
! 	    <ul>
! 	    <?php foreach($cont as $key => $val) { ?>
! 	      <li id="<?php echo htmlspecialchars($val['id']) ?>"><a href="<?php echo htmlspecialchars($val['href']) ?>"><?php echo htmlspecialchars($val['text'])?></a></li>
! 	     <?php } ?>
! 	    </ul>
! 	  </div>
  	</div>
  	<?php } ?>
  	<div id="p-search" class="portlet">
! 	  <h5><label for="searchInput"><?php $this->msg('search') ?></label></h5>
! 	  <div class="pBody">
! 	    <form name="searchform" action="<?php $this->text('searchaction') ?>" id="searchform">
! 	      <input id="searchInput" name="search" type="text"
! 	        <?php if($this->haveMsg('accesskey-search')) {
! 	          ?>accesskey="<?php $this->msg('accesskey-search') ?>"<?php }
! 	        if( isset( $this->data['search'] ) ) {
! 	          ?> value="<?php $this->text('search') ?>"<?php } ?> />
! 	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
! 	        value="<?php $this->msg('go') ?>"
! 	        />&nbsp;<input type='submit' name="fulltext"
! 	        class="searchButton"
! 	        value="<?php $this->msg('search') ?>" />
! 	    </form>
! 	  </div>
  	</div>
  	<div class="portlet" id="p-tb">
! 	  <h5><?php $this->msg('toolbox') ?></h5>
! 	  <div class="pBody">
! 	    <ul>
! 		  <?php if($this->data['notspecialpage']) { foreach( array( 'whatlinkshere', 'recentchangeslinked' ) as $special ) { ?>
! 		  <li id="t-<?php echo $special?>"><a href="<?php
! 		    echo htmlspecialchars($this->data['nav_urls'][$special]['href'])
! 		    ?>"><?php echo $this->msg($special) ?></a></li>
! 		  <?php } } ?>
!               <?php if(isset($this->data['nav_urls']['trackbacklink'])) { ?>
! 		  <li id="t-trackbacklink"><a href="<?php
! 		    echo htmlspecialchars($this->data['nav_urls']['trackbacklink']['href'])
! 		    ?>"><?php echo $this->msg('trackbacklink') ?></a></li>
! 	      <?php } ?>
! 	      <?php if($this->data['feeds']) { ?><li id="feedlinks"><?php foreach($this->data['feeds'] as $key => $feed) {
! 	        ?><span id="feed-<?php echo htmlspecialchars($key) ?>"><a href="<?php
! 	        echo htmlspecialchars($feed['href']) ?>"><?php echo htmlspecialchars($feed['text'])?></a>&nbsp;</span>
! 	        <?php } ?></li><?php } ?>
! 	      <?php foreach( array('contributions', 'emailuser', 'upload', 'specialpages') as $special ) { ?>
! 	      <?php if($this->data['nav_urls'][$special]) {?><li id="t-<?php echo $special ?>"><a href="<?php
! 	        echo htmlspecialchars($this->data['nav_urls'][$special]['href'])
! 	        ?>"><?php $this->msg($special) ?></a></li><?php } ?>
! 	      <?php } ?>
! 	      <?php if(!empty($this->data['nav_urls']['print']['href'])) { ?>
! 	      <li id="t-print"><a href="<?php
! 		    echo htmlspecialchars($this->data['nav_urls']['print']['href'])
! 		    ?>"><?php echo $this->msg('printableversion') ?></a></li>
! 	      <?php } ?>
! 	    </ul>
! 	  </div>
  	</div>
! 	<?php if( $this->data['language_urls'] ) { ?><div id="p-lang" class="portlet">
! 	  <h5><?php $this->msg('otherlanguages') ?></h5>
! 	  <div class="pBody">
! 	    <ul>
! 	      <?php foreach($this->data['language_urls'] as $langlink) { ?>
! 	      <li class="<?php echo htmlspecialchars($langlink['class'])?>">
! 	      <a href="<?php echo htmlspecialchars($langlink['href'])
! 	        ?>"><?php echo $langlink['text'] ?></a>
! 	      </li>
! 	      <?php } ?>
! 	    </ul>
! 	  </div>
  	</div>
! 	<?php } ?>
!       </div><!-- end of the left (by default at least) column -->
!       <div class="visualClear"></div>
!       <div id="footer">
!     <?php if($this->data['poweredbyico']) { ?><div id="f-poweredbyico"><?php $this->html('poweredbyico') ?></div><?php } ?>
! 	<?php if($this->data['copyrightico']) { ?><div id="f-copyrightico"><?php $this->html('copyrightico') ?></div><?php } ?>
! 	<ul id="f-list">
! 	  <?php if($this->data['lastmod'   ]) { ?><li id="f-lastmod"><?php    $this->html('lastmod')    ?></li><?php } ?>
! 	  <?php if($this->data['viewcount' ]) { ?><li id="f-viewcount"><?php  $this->html('viewcount')  ?></li><?php } ?>
! 	  <?php if($this->data['numberofwatchingusers' ]) { ?><li id="f-numberofwatchingusers"><?php  $this->html('numberofwatchingusers') ?></li><?php } ?>
! 	  <?php if($this->data['credits'   ]) { ?><li id="f-credits"><?php    $this->html('credits')    ?></li><?php } ?>
! 	  <?php if($this->data['copyright' ]) { ?><li id="f-copyright"><?php  $this->html('copyright')  ?></li><?php } ?>
! 	  <?php if($this->data['about'     ]) { ?><li id="f-about"><?php      $this->html('about')      ?></li><?php } ?>
! 	  <?php if($this->data['disclaimer']) { ?><li id="f-disclaimer"><?php $this->html('disclaimer') ?></li><?php } ?>
! 	  <?php if($this->data['tagline']) { ?><li id="f-tagline"><?php echo $this->data['tagline'] ?></li><?php } ?>
! 	</ul>
!       </div>
!     </div>
!     <?php $this->html('reporttime') ?>
!   </body>
! </html>
  <?php
  	wfRestoreWarnings();
! 	}
! }
  ?>
--- 55,275 ----
             "<?php $this->text('dtd'); ?>">
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php $this->text('lang') ?>" lang="<?php $this->text('lang') ?>" dir="<?php $this->text('dir') ?>">
! 	<head>
! 		<meta http-equiv="Content-Type" content="<?php $this->text('mimetype') ?>; charset=<?php $this->text('charset') ?>" />
! 		<?php $this->html('headlinks') ?>
! 		<?php $this->html('headscripts') ?>
! 		<title><?php $this->text('pagetitle') ?></title>
! 		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/main.css?5"; /*]]>*/</style>
! 		<link rel="stylesheet" type="text/css" <?php if(empty($this->data['printable']) ) { ?>media="print"<?php } ?> href="<?php $this->text('stylepath') ?>/common/commonPrint.css" />
! 		<!--[if lt IE 5.5000]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE50Fixes.css";</style><![endif]-->
! 		<!--[if IE 5.5000]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE55Fixes.css";</style><![endif]-->
! 		<!--[if IE 6]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE60Fixes.css";</style><![endif]-->
! 		<!--[if IE 7]><style type="text/css">@import "<?php $this->text('stylepath') ?>/<?php $this->text('stylename') ?>/IE70Fixes.css?1";</style><![endif]-->
! 		<!--[if lt IE 7]><script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('stylepath') ?>/common/IEFixes.js"></script>
! 		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->
! 		<script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('stylepath' ) ?>/common/wikibits.js"><!-- wikibits js --></script>
! <?php	if($this->data['jsvarurl'  ]) { ?>
! 		<script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('jsvarurl'  ) ?>"><!-- site js --></script>
! <?php	} ?>
! <?php	if($this->data['pagecss'   ]) { ?>
! 		<style type="text/css"><?php $this->html('pagecss'   ) ?></style>
! <?php	}
! 		if($this->data['usercss'   ]) { ?>
! 		<style type="text/css"><?php $this->html('usercss'   ) ?></style>
! <?php	}
! 		if($this->data['userjs'    ]) { ?>
! 		<script type="<?php $this->text('jsmimetype') ?>" src="<?php $this->text('userjs' ) ?>"></script>
! <?php	}
! 		if($this->data['userjsprev']) { ?>
! 		<script type="<?php $this->text('jsmimetype') ?>"><?php $this->html('userjsprev') ?></script>
! <?php	}
! 		if($this->data['trackbackhtml']) print $this->data['trackbackhtml']; ?>
! 	</head>
! <body <?php if($this->data['body_ondblclick']) { ?>ondblclick="<?php $this->text('body_ondblclick') ?>"<?php } ?>
! <?php if($this->data['body_onload'    ]) { ?>onload="<?php     $this->text('body_onload')     ?>"<?php } ?>
!  class="<?php $this->text('nsclass') ?> <?php $this->text('dir') ?>">
! 	<div id="globalWrapper">
! 		<div id="column-content">
  	<div id="content">
! 		<a name="top" id="top"></a>
! 		<?php if($this->data['sitenotice']) { ?><div id="siteNotice"><?php $this->html('sitenotice') ?></div><?php } ?>
! 		<h1 class="firstHeading"><?php $this->text('title') ?></h1>
! 		<div id="bodyContent">
! 			<h3 id="siteSub"><?php $this->msg('tagline') ?></h3>
! 			<div id="contentSub"><?php $this->html('subtitle') ?></div>
! 			<?php if($this->data['undelete']) { ?><div id="contentSub2"><?php     $this->html('undelete') ?></div><?php } ?>
! 			<?php if($this->data['newtalk'] ) { ?><div class="usermessage"><?php $this->html('newtalk')  ?></div><?php } ?>
! 			<?php if($this->data['showjumplinks']) { ?><div id="jump-to-nav"><?php $this->msg('jumpto') ?> <a href="#column-one"><?php $this->msg('jumptonavigation') ?></a>, <a href="#searchInput"><?php $this->msg('jumptosearch') ?></a></div><?php } ?>
! 			<!-- start content -->
! 			<?php $this->html('bodytext') ?>
! 			<?php if($this->data['catlinks']) { ?><div id="catlinks"><?php       $this->html('catlinks') ?></div><?php } ?>
! 			<!-- end content -->
! 			<div class="visualClear"></div>
! 		</div>
  	</div>
! 		</div>
! 		<div id="column-one">
  	<div id="p-cactions" class="portlet">
! 		<h5><?php $this->msg('views') ?></h5>
! 		<ul>
! <?php			foreach($this->data['content_actions'] as $key => $tab) { ?>
! 				 <li id="ca-<?php echo htmlspecialchars($key) ?>"<?php
! 				 	if($tab['class']) { ?> class="<?php echo htmlspecialchars($tab['class']) ?>"<?php }
! 				 ?>><a href="<?php echo htmlspecialchars($tab['href']) ?>"><?php
! 				 echo htmlspecialchars($tab['text']) ?></a></li>
! <?php			 } ?>
! 		</ul>
  	</div>
  	<div class="portlet" id="p-personal">
! 		<h5><?php $this->msg('personaltools') ?></h5>
! 		<div class="pBody">
! 			<ul>
! <?php 			foreach($this->data['personal_urls'] as $key => $item) { ?>
! 				<li id="pt-<?php echo htmlspecialchars($key) ?>"<?php
! 					if ($item['active']) { ?> class="active"<?php } ?>><a href="<?php
! 				echo htmlspecialchars($item['href']) ?>"<?php
! 				if(!empty($item['class'])) { ?> class="<?php
! 				echo htmlspecialchars($item['class']) ?>"<?php } ?>><?php
! 				echo htmlspecialchars($item['text']) ?></a></li>
! <?php			} ?>
! 			</ul>
! 		</div>
  	</div>
  	<div class="portlet" id="p-logo">
! 		<a style="background-image: url(<?php $this->text('logopath') ?>);" <?php
! 			?>href="<?php echo htmlspecialchars($this->data['nav_urls']['mainpage']['href'])?>" <?php
! 			?>title="<?php $this->msg('mainpage') ?>"></a>
  	</div>
  	<script type="<?php $this->text('jsmimetype') ?>"> if (window.isMSIE55) fixalpha(); </script>
  	<?php foreach ($this->data['sidebar'] as $bar => $cont) { ?>
  	<div class='portlet' id='p-<?php echo htmlspecialchars($bar) ?>'>
! 		<h5><?php $out = wfMsg( $bar ); if (wfEmptyMsg($bar, $out)) echo $bar; else echo $out; ?></h5>
! 		<div class='pBody'>
! 			<ul>
! <?php 			foreach($cont as $key => $val) { ?>
! 				<li id="<?php echo htmlspecialchars($val['id']) ?>"<?php
! 					if ( $val['active'] ) { ?> class="active" <?php }
! 				?>><a href="<?php echo htmlspecialchars($val['href']) ?>"><?php echo htmlspecialchars($val['text']) ?></a></li>
! <?php			} ?>
! 			</ul>
! 		</div>
  	</div>
  	<?php } ?>
  	<div id="p-search" class="portlet">
! 		<h5><label for="searchInput"><?php $this->msg('search') ?></label></h5>
! 		<div id="searchBody" class="pBody">
! 			<form action="<?php $this->text('searchaction') ?>" id="searchform"><div>
! 				<input id="searchInput" name="search" type="text" <?php
! 					if($this->haveMsg('accesskey-search')) {
! 						?>accesskey="<?php $this->msg('accesskey-search') ?>"<?php }
! 					if( isset( $this->data['search'] ) ) {
! 						?> value="<?php $this->text('search') ?>"<?php } ?> />
! 				<input type='submit' name="go" class="searchButton" id="searchGoButton"	value="<?php $this->msg('go') ?>" />&nbsp;
! 				<input type='submit' name="fulltext" class="searchButton" value="<?php $this->msg('search') ?>" />
! 			</div></form>
! 		</div>
  	</div>
  	<div class="portlet" id="p-tb">
! 		<h5><?php $this->msg('toolbox') ?></h5>
! 		<div class="pBody">
! 			<ul>
! <?php
! 		if($this->data['notspecialpage']) { ?>
! 				<li id="t-whatlinkshere"><a href="<?php
! 				echo htmlspecialchars($this->data['nav_urls']['whatlinkshere']['href'])
! 				?>"><?php $this->msg('whatlinkshere') ?></a></li>
! <?php
! 			if( $this->data['nav_urls']['recentchangeslinked'] ) { ?>
! 				<li id="t-recentchangeslinked"><a href="<?php
! 				echo htmlspecialchars($this->data['nav_urls']['recentchangeslinked']['href'])
! 				?>"><?php $this->msg('recentchangeslinked') ?></a></li>
! <?php 		}
! 		}
! 		if(isset($this->data['nav_urls']['trackbacklink'])) { ?>
! 			<li id="t-trackbacklink"><a href="<?php
! 				echo htmlspecialchars($this->data['nav_urls']['trackbacklink']['href'])
! 				?>"><?php $this->msg('trackbacklink') ?></a></li>
! <?php 	}
! 		if($this->data['feeds']) { ?>
! 			<li id="feedlinks"><?php foreach($this->data['feeds'] as $key => $feed) {
! 					?><span id="feed-<?php echo htmlspecialchars($key) ?>"><a href="<?php
! 					echo htmlspecialchars($feed['href']) ?>"><?php echo htmlspecialchars($feed['text'])?></a>&nbsp;</span>
! 					<?php } ?></li><?php
! 		}
! 
! 		foreach( array('contributions', 'blockip', 'emailuser', 'upload', 'specialpages') as $special ) {
! 
! 			if($this->data['nav_urls'][$special]) {
! 				?><li id="t-<?php echo $special ?>"><a href="<?php echo htmlspecialchars($this->data['nav_urls'][$special]['href'])
! 				?>"><?php $this->msg($special) ?></a></li>
! <?php		}
! 		}
! 
! 		if(!empty($this->data['nav_urls']['print']['href'])) { ?>
! 				<li id="t-print"><a href="<?php echo htmlspecialchars($this->data['nav_urls']['print']['href'])
! 				?>"><?php $this->msg('printableversion') ?></a></li><?php
! 		}
! 
! 		if(!empty($this->data['nav_urls']['permalink']['href'])) { ?>
! 				<li id="t-permalink"><a href="<?php echo htmlspecialchars($this->data['nav_urls']['permalink']['href'])
! 				?>"><?php $this->msg('permalink') ?></a></li><?php
! 		} elseif ($this->data['nav_urls']['permalink']['href'] === '') { ?>
! 				<li id="t-ispermalink"><?php $this->msg('permalink') ?></li><?php
! 		}
! 
! 		wfRunHooks( 'MonoBookTemplateToolboxEnd', array( &$this ) );
! ?>
! 			</ul>
! 		</div>
  	</div>
! <?php
! 		if( $this->data['language_urls'] ) { ?>
! 	<div id="p-lang" class="portlet">
! 		<h5><?php $this->msg('otherlanguages') ?></h5>
! 		<div class="pBody">
! 			<ul>
! <?php		foreach($this->data['language_urls'] as $langlink) { ?>
! 				<li class="<?php echo htmlspecialchars($langlink['class'])?>"><?php
! 				?><a href="<?php echo htmlspecialchars($langlink['href']) ?>"><?php echo $langlink['text'] ?></a></li>
! <?php		} ?>
! 			</ul>
! 		</div>
  	</div>
! <?php	} ?>
! 		</div><!-- end of the left (by default at least) column -->
! 			<div class="visualClear"></div>
! 			<div id="footer">
! <?php
! 		if($this->data['poweredbyico']) { ?>
! 				<div id="f-poweredbyico"><?php $this->html('poweredbyico') ?></div>
! <?php 	}
! 		if($this->data['copyrightico']) { ?>
! 				<div id="f-copyrightico"><?php $this->html('copyrightico') ?></div>
! <?php	}
! 
! 		// Generate additional footer links
! ?>
! 			<ul id="f-list">
! <?php
! 		$footerlinks = array(
! 			'lastmod', 'viewcount', 'numberofwatchingusers', 'credits', 'copyright',
! 			'privacy', 'about', 'disclaimer', 'tagline',
! 		);
! 		foreach( $footerlinks as $aLink ) {
! 			if( $this->data[$aLink] ) {
! ?>				<li id="<?php echo$aLink?>"><?php $this->html($aLink) ?></li>
! <?php 		}
! 		}
! ?>
! 			</ul>
! 		</div>
! 	<script type="text/javascript"> if (window.runOnloadHook) runOnloadHook();</script>
! </div>
! <?php $this->html('reporttime') ?>
! 
! </body></html>
  <?php
  	wfRestoreWarnings();
! 	} // end of execute() method
! } // end of class
  ?>



From nobody at sheep.berlios.de  Thu Mar 23 11:40:36 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 11:40:36 +0100
Subject: [Blahtex-cvs] blahtex/skins/disabled Amethyst.php,1.1.1.1,NONE Amethyst.pt,1.1.1.1,NONE Chick.php,1.1.1.1,NONE Chick.pt,1.1.1.1,NONE MonoBook.pt,1.1.1.2,NONE MonoBookTal.php,1.1.1.1,NONE WikimediaWiki.php,1.1.1.1,NONE WikimediaWiki.pt,1.1.1.1,NONE
Message-ID: <200603231040.k2NAeZt01186@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/skins/disabled
In directory sheep:/tmp/cvs-serv25749/skins/disabled

Removed Files:
	Amethyst.php Amethyst.pt Chick.php Chick.pt MonoBook.pt 
	MonoBookTal.php WikimediaWiki.php WikimediaWiki.pt 
Log Message:
Import of MediaWiki CVS from vendor branch

--- Amethyst.php DELETED ---

--- Amethyst.pt DELETED ---

--- Chick.php DELETED ---

--- Chick.pt DELETED ---

--- MonoBook.pt DELETED ---

--- MonoBookTal.php DELETED ---

--- WikimediaWiki.php DELETED ---

--- WikimediaWiki.pt DELETED ---



From nobody at sheep.berlios.de  Thu Mar 23 12:19:50 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 12:19:50 +0100
Subject: [Blahtex-cvs] blahtex/includes Math.php,1.25,1.26
Message-ID: <200603231119.k2NBJot03308@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv30775

Modified Files:
	Math.php 
Log Message:
Merge with MediaWiki CVS from vendor branch:
* (bug 3877) Render math images into temp directory, then move to 
  hashed subdir so you can render new math images and have them work
* Change storage architecture in images/math/.
  Old: images/math/434be915b5fe2e0e63cad907f254dfd5.png
  New: images/math/4/3/4/434be915b5fe2e0e63cad907f254dfd5.png


Index: Math.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Math.php,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** Math.php	14 Mar 2006 12:24:32 -0000	1.25
--- Math.php	23 Mar 2006 11:20:14 -0000	1.26
***************
*** 6,10 ****
  
  class blahtexOutputParser  {
!         var $parser;
  	var $stack;
  	var $results;
--- 6,10 ----
  
  class blahtexOutputParser  {
! 	var $parser;
  	var $stack;
  	var $results;
***************
*** 84,88 ****
  	function MathRenderer( $tex ) {
  		$this->tex = $tex;
!  	}
  	
  	function setOutputMode( $mode ) {
--- 84,88 ----
  	function MathRenderer( $tex ) {
  		$this->tex = $tex;
! 	 }
  	
  	function setOutputMode( $mode ) {
***************
*** 155,160 ****
  					if ( $this->verticalShift != "unknown" )
  					{
! 						global $wgMathDirectory;
! 						$verticalShiftFile = @fopen( "$wgMathDirectory/{$this->hash}.vshift", "wb" );
  						if ( !($verticalShiftFile === false) )
  						{
--- 155,160 ----
  					if ( $this->verticalShift != "unknown" )
  					{
! 						$hashpath = $this->_getHashPath();
! 						$verticalShiftFile = @fopen( "$hashpath/{$this->hash}.vshift", "wb" );
  						if ( !($verticalShiftFile === false) )
  						{
***************
*** 177,189 ****
  	function testEnvironment()
  	{
! 	        global $wgMathDirectory, $wgTmpDirectory, $wgTexvc, $wgBlahtex;
! 
!                 if( !file_exists( $wgMathDirectory ) ) {
! 			if( !@mkdir( $wgMathDirectory ) ) {
! 				return $this->_error( 'math_bad_output' );
! 			}
! 		} elseif( !is_dir( $wgMathDirectory ) || !is_writable( $wgMathDirectory ) ) {
! 			return $this->_error( 'math_bad_output' );
! 		}
  		if( !file_exists( $wgTmpDirectory ) ) {
  			if( !@mkdir( $wgTmpDirectory ) ) {
--- 177,182 ----
  	function testEnvironment()
  	{
! 		global $wgTmpDirectory, $wgTexvc, $wgBlahtex;
! 		
  		if( !file_exists( $wgTmpDirectory ) ) {
  			if( !@mkdir( $wgTmpDirectory ) ) {
***************
*** 197,203 ****
  			return $this->_error( 'math_notexvc' );
  		}
!                 if ($wgBlahtex && function_exists('is_executable') && !is_executable($wgBlahtex))
  			return $this->_error('math_noblahtex', $wgBlahtex);
! 
  		return false;
  	}
--- 190,196 ----
  			return $this->_error( 'math_notexvc' );
  		}
! 		if ($wgBlahtex && function_exists('is_executable') && !is_executable($wgBlahtex))
  			return $this->_error('math_noblahtex', $wgBlahtex);
! 		
  		return false;
  	}
***************
*** 214,218 ****
  		$cmd = $wgTexvc . ' ' . 
  			escapeshellarg( $wgTmpDirectory ).' '.
! 			escapeshellarg( $wgMathDirectory ).' '.
  			escapeshellarg( $this->tex ).' '.
  			escapeshellarg( $wgInputEncoding );
--- 207,211 ----
  		$cmd = $wgTexvc . ' ' . 
  			escapeshellarg( $wgTmpDirectory ).' '.
! 			escapeshellarg( $wgTmpDirectory ).' '.
  			escapeshellarg( $this->tex ).' '.
  			escapeshellarg( $wgInputEncoding );
***************
*** 235,243 ****
  
  	/**
! 	 * Process texvc output and fill the mathml, html, hash, and conservativeness fields.
  	 * Returns an error message, or false if no error occurred.
  	 */
  	function processTexvcOutput($contents) {
! 		global $wgMathDirectory;
  
  		$retval = substr ($contents, 0, 1);
--- 228,237 ----
  
  	/**
! 	 * Process texvc output: fill the mathml, html, hash, and conservativeness fields
! 	 * in the database and move the PNG image to its final destination.
  	 * Returns an error message, or false if no error occurred.
  	 */
  	function processTexvcOutput($contents) {
! 		global $wgTmpDirectory;
  
  		$retval = substr ($contents, 0, 1);
***************
*** 288,295 ****
  		}
  		
! 		if( !file_exists( "$wgMathDirectory/{$hash}.png" ) ) {
  			return $this->_error( 'math_image_error' );
  		}
  		
  		$this->hash = $hash;
  		return false;
--- 282,293 ----
  		}
  		
! 		if( !file_exists( "$wgTmpDirectory/{$hash}.png" ) ) {
  			return $this->_error( 'math_image_error' );
  		}
  		
+ 		$tmp = $this->moveToMathDir( "{$hash}.png" );
+ 		if ( $tmp !== false ) 
+ 			return $tmp;
+ 
  		$this->hash = $hash;
  		return false;
***************
*** 304,314 ****
  	function invokeBlahtex($tex, $makePNG)
  	{
! 		global $wgBlahtex, $wgMathDirectory, $wgTmpDirectory;
  
!                 $descriptorspec = array(0 => array("pipe", "r"),
!                                         1 => array("pipe", "w"));
  		$options = '--mathml --texvc-compatible-commands --mathml-version-1-fonts --disallow-plane-1 --spacing strict';
  		if ($makePNG) {
! 			$options .= " --png --temp-directory $wgTmpDirectory --png-directory $wgMathDirectory";
  			$options .= " --use-ucs-package --use-cjk-package --japanese-font ipam";
  		}
--- 302,312 ----
  	function invokeBlahtex($tex, $makePNG)
  	{
! 		global $wgBlahtex, $wgTmpDirectory;
  
! 		$descriptorspec = array(0 => array("pipe", "r"),
! 					1 => array("pipe", "w"));
  		$options = '--mathml --texvc-compatible-commands --mathml-version-1-fonts --disallow-plane-1 --spacing strict';
  		if ($makePNG) {
! 			$options .= " --png --temp-directory $wgTmpDirectory --png-directory $wgTmpDirectory";
  			$options .= " --use-ucs-package --use-cjk-package --japanese-font ipam";
  		}
***************
*** 342,346 ****
  	 * Process blahtex output and update the mathml and png fields.
  	 * Returns an error message, or false if no error occurred.
! 	 * Bug: assumes that mathml and png errors have no arguments.
  	 */
  	function processBlahtexOutput($results)
--- 340,344 ----
  	 * Process blahtex output and update the mathml and png fields.
  	 * Returns an error message, or false if no error occurred.
! 	 * FIXME: this assumes incorrectly that mathml and png errors have no arguments.
  	 */
  	function processBlahtexOutput($results)
***************
*** 362,371 ****
  			}
  			else	
! 				// Error message has no arguments
! 				return $this->_error('math_' . $results["blahtex:error:id"]);
  
  		} elseif (isset($results["mathmlMarkup"]) || isset($results["blahtex:png:md5"])) {
  			// Case III: We got some results
! 			if (isset($results["mathmlMarkup"])) 	
  				$this->mathml = $results['mathmlMarkup'];
  			if (isset($results["blahtex:png:md5"])) 
--- 360,369 ----
  			}
  			else	
! 			  // Error message has no arguments
! 			  return $this->_error('math_' . $results["blahtex:error:id"]);
  
  		} elseif (isset($results["mathmlMarkup"]) || isset($results["blahtex:png:md5"])) {
  			// Case III: We got some results
! 			if (isset($results["mathmlMarkup"]))	 
  				$this->mathml = $results['mathmlMarkup'];
  			if (isset($results["blahtex:png:md5"])) 
***************
*** 373,376 ****
--- 371,377 ----
  			if (isset($results["blahtex:png:vshift"]))
  				$this->verticalShift = $results["blahtex:png:vshift"];
+ 			$tmp = $this->moveToMathDir( "{$this->hash}.png" );
+ 			if ( $tmp !== false ) 
+ 				return $tmp;
  			return false;
  
***************
*** 385,388 ****
--- 386,410 ----
  	}
  
+ 	/**
+ 	 * Move a file from $wgTmpDirectory to a directory under $wgMathDirectory.
+ 	 * Returns false or an error message.
+ 	 */
+ 	function moveToMathDir( $fname ) {
+ 		global $wgTmpDirectory;
+ 
+ 		$hashpath = $this->_getHashPath();
+ 		if( !file_exists( $hashpath ) ) {
+ 			if( !@wfMkdirParents( $hashpath, 0755 ) ) {
+ 				return $this->_error( 'math_bad_output' );
+ 			}
+ 		} elseif( !is_dir( $hashpath ) || !is_writable( $hashpath ) ) {
+ 			return $this->_error( 'math_bad_output' );
+ 		}
+ 		
+ 		if( !rename( "$wgTmpDirectory/$fname", "$hashpath/$fname" ) ) {
+ 			return $this->_error( 'math_output_error' );
+ 		}
+ 	}
+ 
  	function _error( $msg, $arg1 = '', $arg2 = '' ) {
  		$mf = htmlspecialchars( wfMsg( 'math_failure' ) );
***************
*** 391,396 ****
  		else
  			$errmsg = '';
!                 $source = htmlspecialchars(str_replace("\n", ' ', $this->tex));
!                 // Note: the str_replace above is because the return value must not contain newlines
  		return "<strong class='error'>$mf ($errmsg): $source</strong>\n";
  	}
--- 413,418 ----
  		else
  			$errmsg = '';
! 		$source = htmlspecialchars(str_replace("\n", ' ', $this->tex));
! 		// Note: the str_replace above is because the return value must not contain newlines
  		return "<strong class='error'>$mf ($errmsg): $source</strong>\n";
  	}
***************
*** 403,409 ****
  		$dbr =& wfGetDB( DB_SLAVE );
  		$rpage = $dbr->selectRow( 'math', 
! 			array( 'math_outputhash','math_html_conservativeness','math_html','math_mathml' ),
! 			array( 'math_inputhash' => pack("H32", $this->md5)), # Binary packed, not hex
! 			$fname
  		);
  
--- 425,431 ----
  		$dbr =& wfGetDB( DB_SLAVE );
  		$rpage = $dbr->selectRow( 'math', 
! 					  array( 'math_outputhash','math_html_conservativeness','math_html','math_mathml' ),
! 					  array( 'math_inputhash' => pack("H32", $this->md5)), # Binary packed, not hex
! 					  $fname
  		);
  



From nobody at sheep.berlios.de  Thu Mar 23 12:52:38 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 12:52:38 +0100
Subject: [Blahtex-cvs] blahtex/includes Math.php,1.26,1.27
Message-ID: <200603231152.k2NBqct04470@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv14396

Modified Files:
	Math.php 
Log Message:
Complete the merge.


Index: Math.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Math.php,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** Math.php	23 Mar 2006 11:20:14 -0000	1.26
--- Math.php	23 Mar 2006 11:53:01 -0000	1.27
***************
*** 530,540 ****
  	function _linkToMathImage() {
  		global $wgMathPath;
! 		$url = htmlspecialchars( "$wgMathPath/{$this->hash}.png" );
  		$alt = trim(str_replace("\n", ' ', htmlspecialchars( $this->tex )));
! 		global $wgUseBlahtexVerticalShift;
! 		if ( $wgUseBlahtexVerticalShift && $this->verticalShift != "unknown" )
! 			return "<img class='tex' src=\"$url\" alt=\"$alt\" style=\"vertical-align: {$this->verticalShift}px\" />";
! 		else
! 			return "<img class='tex' src=\"$url\" alt=\"$alt\" />";
  	}
  
--- 530,547 ----
  	function _linkToMathImage() {
  		global $wgMathPath;
! 		$url = htmlspecialchars( "$wgMathPath/" . substr($this->hash, 0, 1)
! 					.'/'. substr($this->hash, 1, 1) .'/'. substr($this->hash, 2, 1)
! 					. "/{$this->hash}.png" );
  		$alt = trim(str_replace("\n", ' ', htmlspecialchars( $this->tex )));
! 		return "<img class='tex' src=\"$url\" alt=\"$alt\" />";
! 	}
! 
! 	function _getHashPath() {
! 		global $wgMathDirectory;
! 		$path = $wgMathDirectory .'/'. substr($this->hash, 0, 1)
! 					.'/'. substr($this->hash, 1, 1)
! 					.'/'. substr($this->hash, 2, 1);
! 		wfDebug( "TeX: getHashPath, hash is: $this->hash, path is: $path\n" );
! 		return $path;
  	}
  



From nobody at sheep.berlios.de  Thu Mar 23 12:58:19 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Thu, 23 Mar 2006 12:58:19 +0100
Subject: [Blahtex-cvs] blahtex/languages Messages.php,1.2,1.3
Message-ID: <200603231158.k2NBwJt04721@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/languages
In directory sheep:/tmp/cvs-serv18292

Modified Files:
	Messages.php 
Log Message:
Remove "if possible" from MathML preference (as before the merge)


Index: Messages.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/languages/Messages.php,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** Messages.php	23 Mar 2006 10:40:58 -0000	1.2
--- Messages.php	23 Mar 2006 11:58:36 -0000	1.3
***************
*** 1576,1580 ****
  'mw_math_source' => 'Leave it as TeX (for text browsers)',
  'mw_math_modern' => 'Recommended for modern browsers',
! 'mw_math_mathml' => 'MathML if possible (experimental)',
  
  # Patrolling
--- 1576,1580 ----
  'mw_math_source' => 'Leave it as TeX (for text browsers)',
  'mw_math_modern' => 'Recommended for modern browsers',
! 'mw_math_mathml' => 'MathML (experimental)',
  
  # Patrolling



From nobody at sheep.berlios.de  Fri Mar 24 12:27:44 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Fri, 24 Mar 2006 12:27:44 +0100
Subject: [Blahtex-cvs] blahtex/includes Math.php,1.27,1.28
Message-ID: <200603241127.k2OBRit32015@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv23768/includes

Modified Files:
	Math.php 
Log Message:
_recall(): Fix incorrect merge attempt


Index: Math.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Math.php,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** Math.php	23 Mar 2006 11:53:01 -0000	1.27
--- Math.php	24 Mar 2006 11:28:08 -0000	1.28
***************
*** 302,314 ****
  	function invokeBlahtex($tex, $makePNG)
  	{
! 		global $wgBlahtex, $wgTmpDirectory;
  
  		$descriptorspec = array(0 => array("pipe", "r"),
  					1 => array("pipe", "w"));
! 		$options = '--mathml --texvc-compatible-commands --mathml-version-1-fonts --disallow-plane-1 --spacing strict';
! 		if ($makePNG) {
  			$options .= " --png --temp-directory $wgTmpDirectory --png-directory $wgTmpDirectory";
- 			$options .= " --use-ucs-package --use-cjk-package --japanese-font ipam";
- 		}
  
  		global $wgUseBlahtexVerticalShift;
--- 302,312 ----
  	function invokeBlahtex($tex, $makePNG)
  	{
! 		global $wgBlahtex, $wgBlahtexOptions, $wgTmpDirectory;
  
  		$descriptorspec = array(0 => array("pipe", "r"),
  					1 => array("pipe", "w"));
! 		$options = '--mathml ' . $wgBlahtexOptions;
! 		if ($makePNG) 
  			$options .= " --png --temp-directory $wgTmpDirectory --png-directory $wgTmpDirectory";
  
  		global $wgUseBlahtexVerticalShift;
***************
*** 443,453 ****
  			$this->mathml = $rpage->math_mathml;
  			
! 			if( $this->hash && !file_exists( "$wgMathDirectory/{$this->hash}.png" ) ) 
! 				$this->hash = NULL;
  
  			global $wgUseBlahtexVerticalShift;
  			if ( $wgUseBlahtexVerticalShift && $this->hash )
  			{
! 				$verticalShiftFile = @fopen( "$wgMathDirectory/{$this->hash}.vshift", "rb" );
  				if ( !($verticalShiftFile === false) )
  				{
--- 441,471 ----
  			$this->mathml = $rpage->math_mathml;
  			
! 			if( file_exists( $this->_getHashPath() . "/{$this->hash}.png" ) ) {
! 				return true;
! 			}
! 
! 			if( file_exists( $wgMathDirectory . "/{$this->hash}.png" ) ) {
! 				$hashpath = $this->_getHashPath();
! 
! 				if( !file_exists( $hashpath ) ) {
! 					if( !@wfMkdirParents( $hashpath, 0755 ) ) {
! 						return false;
! 					}
! 				} elseif( !is_dir( $hashpath ) || !is_writable( $hashpath ) ) {
! 					return false;
! 				}
! 				if ( function_exists( "link" ) ) {
! 					return link ( $wgMathDirectory . "/{$this->hash}.png",
! 							$hashpath . "/{$this->hash}.png" );
! 				} else {
! 					return rename ( $wgMathDirectory . "/{$this->hash}.png",
! 							$hashpath . "/{$this->hash}.png" );
! 				}
! 			}
  
  			global $wgUseBlahtexVerticalShift;
  			if ( $wgUseBlahtexVerticalShift && $this->hash )
  			{
! 				$verticalShiftFile = @fopen( "$hashpath/{$this->hash}.vshift", "rb" );
  				if ( !($verticalShiftFile === false) )
  				{



From nobody at sheep.berlios.de  Fri Mar 24 16:05:11 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Fri, 24 Mar 2006 16:05:11 +0100
Subject: [Blahtex-cvs] blahtex/includes Parser.php,1.3,1.4
Message-ID: <200603241505.k2OF5Bt12076@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv13039/includes

Modified Files:
	Parser.php 
Log Message:
extractTagsAndParams(): Patch from bugzilla:5344


Index: Parser.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Parser.php,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** Parser.php	23 Mar 2006 10:40:58 -0000	1.3
--- Parser.php	24 Mar 2006 15:05:35 -0000	1.4
***************
*** 304,323 ****
  
  		if( $tag == STRIP_COMMENTS ) {
! 			$start = '/<!--()()/';
  			$end   = '/-->/';
  		} else {
! 			$start = "/<$tag(\\s+[^\\/>]*|\\s*)(\\/?)>/i";
  			$end   = "/<\\/$tag\\s*>/i";
  		}
! 
  		while ( '' != $text ) {
  			$p = preg_split( $start, $text, 2, PREG_SPLIT_DELIM_CAPTURE );
  			$stripped .= $p[0];
! 			if( count( $p ) < 4 ) {
  				break;
  			}
  			$attributes = $p[1];
! 			$empty      = $p[2];
! 			$inside     = $p[3];
  
  			$marker = $rnd . sprintf('%08X', $n++);
--- 304,331 ----
  
  		if( $tag == STRIP_COMMENTS ) {
! 			$start = '/<!--()/';
  			$end   = '/-->/';
  		} else {
! 			$start = "/<$tag(\\s+[^>]*|\\s*\/?)>/i";
  			$end   = "/<\\/$tag\\s*>/i";
  		}
! 		
  		while ( '' != $text ) {
  			$p = preg_split( $start, $text, 2, PREG_SPLIT_DELIM_CAPTURE );
  			$stripped .= $p[0];
! 			if( count( $p ) < 3 ) {
  				break;
  			}
  			$attributes = $p[1];
! 			$inside     = $p[2];
! 
! 			// If $attributes ends with '/', we have an empty element tag, <tag />
! 			if ( $tag != STRIP_COMMENTS && substr( $attributes, -1 ) == '/' ) {
! 				$attributes = substr( $attributes, 0, -1);
! 				$empty = '/';
! 			}
! 			else {
! 				$empty = '';
! 			}
  
  			$marker = $rnd . sprintf('%08X', $n++);
***************
*** 328,332 ****
  
  			if ( $empty === '/' ) {
- 				// Empty element tag, <tag />
  				$content[$marker] = null;
  				$text = $inside;
--- 336,339 ----
***************
*** 595,599 ****
  		$math_content = array();
  		$text = Parser::extractTagsAndParams( 'math', $text, $math_content,
! 														  $math_tags, $math_params, $this->mUniqPrefix );
  		$wrappedtext = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"'.
  ' "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html>'.
--- 602,606 ----
  		$math_content = array();
  		$text = Parser::extractTagsAndParams( 'math', $text, $math_content,
! 						      $math_tags, $math_params, $this->mUniqPrefix );
  		$wrappedtext = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"'.
  ' "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html>'.
***************
*** 609,614 ****
  		}
  		foreach( $math_content as $marker => $content ) {
! 		  $full_tag = $math_tags[$marker] . $content . "</math>";
! 		  $correctedtext = str_replace( $marker, $full_tag, $correctedtext );
  		}
  		return $correctedtext;
--- 616,621 ----
  		}
  		foreach( $math_content as $marker => $content ) {
! 			$full_tag = $math_tags[$marker] . $content . "</math>";
! 			$correctedtext = str_replace( $marker, $full_tag, $correctedtext );
  		}
  		return $correctedtext;
***************
*** 656,659 ****
--- 663,667 ----
  			// Some kind of error happened, so we couldn't get the corrected text.
  			// Just give up; we'll use the source text and append a warning.
+ 			wfDebug("tidy invocation: $wgTidyBin -config $wgTidyConf $wgTidyOpts$opts\n");
  			return null;
  		} else {



From nobody at sheep.berlios.de  Sun Mar 26 12:09:15 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:09:15 +0200
Subject: [Blahtex-cvs] blahtex/blahtex/source Messages.cpp,1.4,1.5 main.cpp,1.5,1.6 md5.c,1.5,1.6 md5.h,1.5,1.6
Message-ID: <200603261009.k2QA9Ft14912@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex/source
In directory sheep:/tmp/cvs-serv23511/source

Modified Files:
	Messages.cpp main.cpp md5.c md5.h 
Log Message:
Upgrade to blahtex version 0.4.4


Index: Messages.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/Messages.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** Messages.cpp	14 Mar 2006 11:15:02 -0000	1.4
--- Messages.cpp	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 321,325 ****
          ++ptr
      )
!         output += ptr->first + L"\n" + ptr->second + L"\n";
  
      return output;
--- 321,325 ----
          ++ptr
      )
!         output += ptr->first + L" " + ptr->second + L"\n";
  
      return output;

Index: main.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/main.cpp,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** main.cpp	19 Mar 2006 05:41:46 -0000	1.5
--- main.cpp	26 Mar 2006 10:09:39 -0000	1.6
***************
*** 103,106 ****
--- 103,109 ----
  "More information available at www.blahtex.org\n"
  "\n";
+ 
+     // FIX: need command line option to select output DPI
+ 
      exit(0);
  }

Index: md5.c
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6

Index: md5.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/md5.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6



From nobody at sheep.berlios.de  Sun Mar 26 12:09:15 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:09:15 +0200
Subject: [Blahtex-cvs] blahtex/blahtex README,1.4,1.5
Message-ID: <200603261009.k2QA9Ft14909@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex
In directory sheep:/tmp/cvs-serv23511

Modified Files:
	README 
Log Message:
Upgrade to blahtex version 0.4.4


Index: README
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/README,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** README	30 Jan 2006 00:47:42 -0000	1.4
--- README	26 Mar 2006 10:09:38 -0000	1.5
***************
*** 1,39 ****
! blahtex version 0.4  --  README file
  ======================================
  
- The file blahtex-0.4.tar.gz contains the source code and documentation
- for blahtex version 0.4. It should contain the following files:
- 
-   blahtex-0.4-manual.pdf        ( <== READ THIS !!! )
-   README
-   GNU-GPL
-   history.pdf
-   makefile
-   source/main.cpp
-   source/md5.c
-   source/md5.h
-   source/md5Wrapper.cpp
-   source/md5Wrapper.h
-   source/Messages.cpp
-   source/UnicodeConverter.cpp
-   source/UnicodeConverter.h
-   source/BlahtexCore/Interface.cpp
-   source/BlahtexCore/Interface.h
-   source/BlahtexCore/LayoutTree.cpp
-   source/BlahtexCore/LayoutTree.h
-   source/BlahtexCore/MacroProcessor.cpp
-   source/BlahtexCore/MacroProcessor.h
-   source/BlahtexCore/Manager.cpp
-   source/BlahtexCore/Manager.h
-   source/BlahtexCore/Misc.h
-   source/BlahtexCore/Parser.cpp
-   source/BlahtexCore/Parser.h
-   source/BlahtexCore/ParseTree.h
-   source/BlahtexCore/ParseTree1.cpp
-   source/BlahtexCore/ParseTree2.cpp
-   source/BlahtexCore/ParseTree3.cpp
-   source/BlahtexCore/XmlNode.cpp
-   source/BlahtexCore/XmlNode.h
- 
  
  Blahtex is licensed under the GNU General Public License.
--- 1,5 ----
! blahtex version 0.4.4  --  README file
  ======================================
  
  
  Blahtex is licensed under the GNU General Public License.
***************
*** 41,50 ****
  
  
! For more information, troubleshooting, bug reports, ....
  
!    www.blahtex.org
  
  
! -----------------------
  David Harvey
- 29th January 2006
--- 7,22 ----
  
  
! For more information, troubleshooting, bug reports, manual, ....
  
!    http://www.blahtex.org/
  
  
! 
! Brief build instructions (more details in the manual): run one of
! 
!   make linux
!   make mac  
! 
! 
! ------------
  David Harvey



From nobody at sheep.berlios.de  Sun Mar 26 12:09:16 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:09:16 +0200
Subject: [Blahtex-cvs] blahtex/blahtex/source/BlahtexCore LayoutTree.cpp,1.4,1.5 LayoutTree.h,1.4,1.5 MathmlNode.cpp,1.1,1.2 MathmlNode.h,1.1,1.2 ParseTree1.cpp,1.4,1.5 ParseTree2.cpp,1.4,1.5 ParseTree3.cpp,1.4,1.5 Parser.cpp,1.4,1.5 XmlEncode.cpp,1.1,1.2
Message-ID: <200603261009.k2QA9Gt14917@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore
In directory sheep:/tmp/cvs-serv23511/source/BlahtexCore

Modified Files:
	LayoutTree.cpp LayoutTree.h MathmlNode.cpp MathmlNode.h 
	ParseTree1.cpp ParseTree2.cpp ParseTree3.cpp Parser.cpp 
	XmlEncode.cpp 
Log Message:
Upgrade to blahtex version 0.4.4


Index: LayoutTree.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/LayoutTree.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** LayoutTree.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- LayoutTree.cpp	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 1110,1114 ****
--- 1110,1125 ----
              alignString += (i % 2) ? L" left" : L" right";
          node->mAttributes[MathmlNode::cAttributeColumnalign] = alignString;
+         
+         wstring spacingString = L"0.2em";
+         for (int i = 2; i < tableWidth; i++)
+             spacingString += (i % 2) ? L" 0.2em" : L" 1em";
+         node->mAttributes[MathmlNode::cAttributeColumnspacing] =
+             spacingString;
      }
+     
+     // FIX: need to test this for Firefox whenever they get that bug fixed
+     // (mozilla bug 330964)
+     if (mRowSpacing == cRowSpacingTight)
+         node->mAttributes[MathmlNode::cAttributeRowspacing] = L"0.3ex";
  
      for (vector<vector<Node*> >::const_iterator
***************
*** 1184,1188 ****
  
  
! // This is a list of all symbols that we know how to negate.
  pair<wstring, wstring> gNegationArray[] =
  {
--- 1195,1199 ----
  
  
! // This is a list of all operators that we know how to negate.
  pair<wstring, wstring> gNegationArray[] =
  {

Index: LayoutTree.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/LayoutTree.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** LayoutTree.h	14 Mar 2006 11:15:03 -0000	1.4
--- LayoutTree.h	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 594,604 ****
          }
          mAlign;
  
          Table(
              Style style,
!             RGBColour colour
          ) :
              Node(style, cFlavourOrd, cLimitsDisplayLimits, colour),
!             mAlign(cAlignCentre)
          { }
  
--- 594,616 ----
          }
          mAlign;
+         
+         // How much space to put between rows of the table. Currently
+         // "tight" is used for "\substack" blocks, everything else
+         // gets "normal".
+         enum RowSpacing
+         {
+             cRowSpacingNormal,
+             cRowSpacingTight
+         }
+         mRowSpacing;
  
          Table(
              Style style,
!             RGBColour colour,
!             RowSpacing rowSpacing = cRowSpacingNormal
          ) :
              Node(style, cFlavourOrd, cLimitsDisplayLimits, colour),
!             mAlign(cAlignCentre),
!             mRowSpacing(rowSpacing)
          { }
  

Index: MathmlNode.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/MathmlNode.cpp,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** MathmlNode.cpp	14 Mar 2006 11:15:03 -0000	1.1
--- MathmlNode.cpp	26 Mar 2006 10:09:39 -0000	1.2
***************
*** 206,209 ****
--- 206,211 ----
          L"linethickness",
          L"columnalign",
+         L"columnspacing",
+         L"rowspacing",
          L"fontfamily",
          L"fontstyle",

Index: MathmlNode.h
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/MathmlNode.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** MathmlNode.h	14 Mar 2006 11:15:03 -0000	1.1
--- MathmlNode.h	26 Mar 2006 10:09:39 -0000	1.2
***************
*** 104,107 ****
--- 104,109 ----
          cAttributeLinethickness,
          cAttributeColumnalign,
+         cAttributeColumnspacing,
+         cAttributeRowspacing,
          cAttributeFontfamily,
          cAttributeFontstyle,

Index: ParseTree1.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/ParseTree1.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** ParseTree1.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- ParseTree1.cpp	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 922,926 ****
              newStyle = LayoutTree::Node::cStyleText;
  
!         // FIX: TeX allows "\big."... do we?
          return auto_ptr<LayoutTree::Node>(
              new LayoutTree::SymbolOperator(
--- 922,926 ----
              newStyle = LayoutTree::Node::cStyleText;
  
!         // FIX: TeX allows "\big."; do we?
          return auto_ptr<LayoutTree::Node>(
              new LayoutTree::SymbolOperator(
***************
*** 1017,1024 ****
          make_pair(L"Bmatrix",      EnvironmentInfo(L"{",      L"}")),
          make_pair(L"vmatrix",      EnvironmentInfo(L"|",      L"|")),
!         make_pair(L"Vmatrix",
!             // DoubleVerticalBar:
!             EnvironmentInfo(L"\U00002225", L"\U00002225")
!         ),
          make_pair(L"cases",        EnvironmentInfo(L"{",      L"")),
          make_pair(L"aligned",      EnvironmentInfo(L"",       L"")),
--- 1017,1022 ----
          make_pair(L"Bmatrix",      EnvironmentInfo(L"{",      L"}")),
          make_pair(L"vmatrix",      EnvironmentInfo(L"|",      L"|")),
!         // DoubleVerticalBar:
!         make_pair(L"Vmatrix",      EnvironmentInfo(L"\U00002225", L"\U00002225")),
          make_pair(L"cases",        EnvironmentInfo(L"{",      L"")),
          make_pair(L"aligned",      EnvironmentInfo(L"",       L"")),
***************
*** 1046,1053 ****
      newState.mMathFont.mIsBoldsymbol = state.mMathFont.mIsBoldsymbol;
  
-     // FIX: I think probably the substack rows need to be closer together,
-     // but Firefox doesn't respect the "rowspacing" attribute on <mtable>.
-     // Need to report that and write some code here too.
- 
      LayoutTree::Node::Style fencedStyle;
      if (mName == L"smallmatrix" || mName == L"substack")
--- 1044,1047 ----
***************
*** 1065,1076 ****
  
      auto_ptr<LayoutTree::Node> table = mTable->BuildLayoutTree(newState);
  
!     if (mName == L"aligned")
!         dynamic_cast<LayoutTree::Table*>(table.get())->mAlign
!             = LayoutTree::Table::cAlignRightLeft;
  
      else if (mName == L"cases")
!         dynamic_cast<LayoutTree::Table*>(table.get())->mAlign
!             = LayoutTree::Table::cAlignLeft;
  
      if (environmentLookup->second.mLeftDelimiter.empty() &&
--- 1059,1076 ----
  
      auto_ptr<LayoutTree::Node> table = mTable->BuildLayoutTree(newState);
+     LayoutTree::Table* tablePtr =
+         dynamic_cast<LayoutTree::Table*>(table.get());
+     if (!tablePtr)
+         throw logic_error(
+             "Unexpected node type in MathEnvironment::BuildLayoutTree"
+         );
  
!     if (mName == L"substack")
!         tablePtr->mRowSpacing = LayoutTree::Table::cRowSpacingTight;
  
+     if (mName == L"aligned")
+         tablePtr->mAlign = LayoutTree::Table::cAlignRightLeft;
      else if (mName == L"cases")
!         tablePtr->mAlign = LayoutTree::Table::cAlignLeft;
  
      if (environmentLookup->second.mLeftDelimiter.empty() &&
***************
*** 1098,1135 ****
      // about which font they select.
      static pair<wstring, TexTextFont> textCommandArray[] =
!     {                         // flags are:     bold?  italic?
!         make_pair(L"\\mbox",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         ),
!         make_pair(L"\\hbox",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         ),
!         make_pair(L"\\text",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         ),
!         make_pair(L"\\textrm",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         ),
!         make_pair(L"\\textbf",
!             TexTextFont(TexTextFont::cFamilyRm, true,  false)
!         ),
!         make_pair(L"\\emph",
!             TexTextFont(TexTextFont::cFamilyRm, false, true)
!         ),
!         make_pair(L"\\textit",
!             TexTextFont(TexTextFont::cFamilyRm, false, true)
!         ),
!         make_pair(L"\\textsf",
!             TexTextFont(TexTextFont::cFamilySf, false, false)
!         ),
!         make_pair(L"\\texttt",
!             TexTextFont(TexTextFont::cFamilyTt, false, false)
!         ),
!         make_pair(L"\\cyr",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         ),
!         make_pair(L"\\jap",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         )
      };
      static wishful_hash_map<wstring, TexTextFont> textCommandTable(
--- 1098,1113 ----
      // about which font they select.
      static pair<wstring, TexTextFont> textCommandArray[] =
!     {                                             // flags are:     bold?  italic?
!         make_pair(L"\\mbox",    TexTextFont(TexTextFont::cFamilyRm, false, false)),
!         make_pair(L"\\hbox",    TexTextFont(TexTextFont::cFamilyRm, false, false)),
!         make_pair(L"\\text",    TexTextFont(TexTextFont::cFamilyRm, false, false)),
!         make_pair(L"\\textrm",  TexTextFont(TexTextFont::cFamilyRm, false, false)),
!         make_pair(L"\\textbf",  TexTextFont(TexTextFont::cFamilyRm, true,  false)),
!         make_pair(L"\\emph",    TexTextFont(TexTextFont::cFamilyRm, false, true)),
!         make_pair(L"\\textit",  TexTextFont(TexTextFont::cFamilyRm, false, true)),
!         make_pair(L"\\textsf",  TexTextFont(TexTextFont::cFamilySf, false, false)),
!         make_pair(L"\\texttt",  TexTextFont(TexTextFont::cFamilyTt, false, false)),
!         make_pair(L"\\cyr",     TexTextFont(TexTextFont::cFamilyRm, false, false)),
!         make_pair(L"\\jap",     TexTextFont(TexTextFont::cFamilyRm, false, false))
      };
      static wishful_hash_map<wstring, TexTextFont> textCommandTable(
***************
*** 1217,1220 ****
--- 1195,1199 ----
          make_pair(L"\\&",                 L"&"),
          // FIX: why did I put in these next two lines again?
+         // FIX: The character "<" and ">" actually do funny things in TeX...
          make_pair(L"<",                   L"<"),
          make_pair(L">",                   L">"),

Index: ParseTree2.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/ParseTree2.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** ParseTree2.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- ParseTree2.cpp	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 128,1372 ****
  pair<wstring, OperatorInfo> operatorArray[] =
  {
!     make_pair(L"(",
!         OperatorInfo(L"(", LayoutTree::Node::cFlavourOpen)
!     ),
!     make_pair(L")",
!         OperatorInfo(L")", LayoutTree::Node::cFlavourClose)
!     ),
!     make_pair(L"[",
!         OperatorInfo(L"[", LayoutTree::Node::cFlavourOpen)
[...1864 lines suppressed...]
!     make_pair(L"\\Re",          IdentifierInfo(false, L"\U0000211C", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\Im",          IdentifierInfo(false, L"\U00002111", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\infty",       IdentifierInfo(false, L"\U0000221E", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\hbar",        IdentifierInfo(false, L"\U00000127", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\emptyset",    IdentifierInfo(false, L"\U00002205", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\varnothing",  IdentifierInfo(false, L"\U000000D8", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\S",           IdentifierInfo(false, L"\U000000A7", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\eth",         IdentifierInfo(false, L"\U000000F0", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\hslash",      IdentifierInfo(false, L"\U0000210F", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\mho",         IdentifierInfo(false, L"\U00002127", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\circledR",    IdentifierInfo(false, L"\U000000AE", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\yen",         IdentifierInfo(false, L"\U000000A5", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\maltese",     IdentifierInfo(false, L"\U00002720", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\circledS",    IdentifierInfo(false, L"\U000024C8", LayoutTree::Node::cFlavourOrd)),
      // FIX: these two needs special testing since they're plane-1:
      // FIX: need to update mediawiki to recognise these entities
!     make_pair(L"\\Bbbk",        IdentifierInfo(false, L"\U0001D55C", LayoutTree::Node::cFlavourOrd)),
!     make_pair(L"\\jmath",       IdentifierInfo(true,  L"\U0001D6A5", LayoutTree::Node::cFlavourOrd))
  };
  wishful_hash_map<wstring, IdentifierInfo> identifierTable(

Index: ParseTree3.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/ParseTree3.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** ParseTree3.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- ParseTree3.cpp	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 228,243 ****
      static pair<wstring, LayoutTree::Node::Style> styleCommandArray[] =
      {
!         make_pair(L"\\displaystyle",
!             LayoutTree::Node::cStyleDisplay
!         ),
!         make_pair(L"\\textstyle",
!             LayoutTree::Node::cStyleText
!         ),
!         make_pair(L"\\scriptstyle",
!             LayoutTree::Node::cStyleScript
!         ),
!         make_pair(L"\\scriptscriptstyle",
!             LayoutTree::Node::cStyleScriptScript
!         )
      };
      static wishful_hash_map<wstring, LayoutTree::Node::Style>
--- 228,235 ----
      static pair<wstring, LayoutTree::Node::Style> styleCommandArray[] =
      {
!         make_pair(L"\\displaystyle",       LayoutTree::Node::cStyleDisplay),
!         make_pair(L"\\textstyle",          LayoutTree::Node::cStyleText),
!         make_pair(L"\\scriptstyle",        LayoutTree::Node::cStyleScript),
!         make_pair(L"\\scriptscriptstyle",  LayoutTree::Node::cStyleScriptScript)
      };
      static wishful_hash_map<wstring, LayoutTree::Node::Style>
***************
*** 290,313 ****
  {
      static pair<wstring, TexTextFont> textCommandArray[] =
!     {                                       //  bold?  italic?
!         make_pair(L"\\rm",
!             TexTextFont(TexTextFont::cFamilyRm, false, false)
!         ),
! 
!         make_pair(L"\\it",
!             TexTextFont(TexTextFont::cFamilyRm, false, true)
!         ),
! 
!         make_pair(L"\\bf",
!             TexTextFont(TexTextFont::cFamilyRm, true, false)
!         ),
! 
!         make_pair(L"\\sf",
!             TexTextFont(TexTextFont::cFamilySf, false, false)
!         ),
! 
!         make_pair(L"\\tt",
!             TexTextFont(TexTextFont::cFamilyTt, false, false)
!         ),
      };
      static wishful_hash_map<wstring, TexTextFont> textCommandTable(
--- 282,291 ----
  {
      static pair<wstring, TexTextFont> textCommandArray[] =
!     {                                                       //  bold?  italic?
!         make_pair(L"\\rm",  TexTextFont(TexTextFont::cFamilyRm, false, false)),
!         make_pair(L"\\it",  TexTextFont(TexTextFont::cFamilyRm, false, true)),
!         make_pair(L"\\bf",  TexTextFont(TexTextFont::cFamilyRm, true,  false)),
!         make_pair(L"\\sf",  TexTextFont(TexTextFont::cFamilySf, false, false)),
!         make_pair(L"\\tt",  TexTextFont(TexTextFont::cFamilyTt, false, false)),
      };
      static wishful_hash_map<wstring, TexTextFont> textCommandTable(
***************
*** 917,921 ****
      if (mIsShort)
      {
!         beginCommand = L"\\" + mName + L"{";
          endCommand = L"}";
      }
--- 895,901 ----
      if (mIsShort)
      {
!         beginCommand = L"\\" + mName;
!         features.Update(beginCommand);
!         beginCommand += L"{";
          endCommand = L"}";
      }
***************
*** 923,931 ****
      {
          beginCommand = L"\\begin{" + mName + L"}";
          endCommand = L"\\end{" + mName + L"}";
      }
      
-     features.Update(beginCommand);
-     
      os << beginCommand;
      mTable->GetPurifiedTex(os, features, fontEncoding);
--- 903,910 ----
      {
          beginCommand = L"\\begin{" + mName + L"}";
+         features.Update(beginCommand);
          endCommand = L"\\end{" + mName + L"}";
      }
      
      os << beginCommand;
      mTable->GetPurifiedTex(os, features, fontEncoding);
***************
*** 1008,1014 ****
          END_ARRAY(gSimpleUnicodeArray)
      );
- 
-     // FIX: need command line option to select output DPI
-     // FIX: the above comment doesn't belong here
  
      if (mCommand.size() > 1 || mCommand[0] <= 0x7F)
--- 987,990 ----

Index: Parser.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/Parser.cpp,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** Parser.cpp	14 Mar 2006 11:15:03 -0000	1.4
--- Parser.cpp	26 Mar 2006 10:09:39 -0000	1.5
***************
*** 453,456 ****
--- 453,457 ----
      // changes. TeX only uses TWO sizes for its "large operators".
      // textstyle and below should all be the same size.
+     // Although, amsmath does things differently: investigate that.
  
      make_pair(L"\\sum",                    Parser::cSymbolUnsafe),

Index: XmlEncode.cpp
===================================================================
RCS file: /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore/XmlEncode.cpp,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** XmlEncode.cpp	14 Mar 2006 11:15:03 -0000	1.1
--- XmlEncode.cpp	26 Mar 2006 10:09:39 -0000	1.2
***************
*** 56,1394 ****
  pair<wchar_t, UnicodeNameInfo> gUnicodeNameArray[] =
  {
!     make_pair(L'\U00000060',
!         UnicodeNameInfo(L"grave", L"DiacriticalGrave")
!     ),
!     make_pair(L'\U000000A0',
!         UnicodeNameInfo(L"nbsp", L"NonBreakingSpace")
!     ),
!     make_pair(L'\U000000A7',
!         UnicodeNameInfo(L"sect")
[...1854 lines suppressed...]
!     make_pair(L'\U0001D546', UnicodeNameInfo(L"Oopf")),
!     make_pair(L'\U0001D54A', UnicodeNameInfo(L"Sopf")),
!     make_pair(L'\U0001D54B', UnicodeNameInfo(L"Topf")),
!     make_pair(L'\U0001D54C', UnicodeNameInfo(L"Uopf")),
!     make_pair(L'\U0001D54D', UnicodeNameInfo(L"Vopf")),
!     make_pair(L'\U0001D54E', UnicodeNameInfo(L"Wopf")),
!     make_pair(L'\U0001D54F', UnicodeNameInfo(L"Xopf")),
!     make_pair(L'\U0001D550', UnicodeNameInfo(L"Yopf")),
!     make_pair(L'\U0001D55C', UnicodeNameInfo(L"kopf")),
!     make_pair(L'\U0001D6A5', UnicodeNameInfo())
  };
  
***************
*** 1403,1406 ****
--- 600,604 ----
  // In particular, does the current strategy work for *named* entities
  // and combining characters? I'm not sure.
+ 
  
  // XmlEncode() handles conversion of non-ASCII characters to entities.



From nobody at sheep.berlios.de  Sun Mar 26 12:10:22 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:10:22 +0200
Subject: [Blahtex-cvs] blahtex/blahtex GNU-FDL,NONE,1.1 logo.png,NONE,1.1 manual.tex,NONE,1.1
Message-ID: <200603261010.k2QAAMt14989@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex
In directory sheep:/tmp/cvs-serv23794

Added Files:
	GNU-FDL logo.png manual.tex 
Log Message:
Upgrade to blahtex 0.4.4


--- NEW FILE: GNU-FDL ---
		GNU Free Documentation License
		  Version 1.2, November 2002


 Copyright (C) 2000,2001,2002  Free Software Foundation, Inc.
     51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.


0. PREAMBLE

The purpose of this License is to make a manual, textbook, or other
functional and useful document "free" in the sense of freedom: to
assure everyone the effective freedom to copy and redistribute it,
with or without modifying it, either commercially or noncommercially.
Secondarily, this License preserves for the author and publisher a way
to get credit for their work, while not being considered responsible
for modifications made by others.

This License is a kind of "copyleft", which means that derivative
works of the document must themselves be free in the same sense.  It
complements the GNU General Public License, which is a copyleft
license designed for free software.

We have designed this License in order to use it for manuals for free
software, because free software needs free documentation: a free
program should come with manuals providing the same freedoms that the
software does.  But this License is not limited to software manuals;
it can be used for any textual work, regardless of subject matter or
whether it is published as a printed book.  We recommend this License
principally for works whose purpose is instruction or reference.


1. APPLICABILITY AND DEFINITIONS

This License applies to any manual or other work, in any medium, that
contains a notice placed by the copyright holder saying it can be
distributed under the terms of this License.  Such a notice grants a
world-wide, royalty-free license, unlimited in duration, to use that
work under the conditions stated herein.  The "Document", below,
refers to any such manual or work.  Any member of the public is a
licensee, and is addressed as "you".  You accept the license if you
copy, modify or distribute the work in a way requiring permission
under copyright law.

A "Modified Version" of the Document means any work containing the
Document or a portion of it, either copied verbatim, or with
modifications and/or translated into another language.

A "Secondary Section" is a named appendix or a front-matter section of
the Document that deals exclusively with the relationship of the
publishers or authors of the Document to the Document's overall subject
(or to related matters) and contains nothing that could fall directly
within that overall subject.  (Thus, if the Document is in part a
textbook of mathematics, a Secondary Section may not explain any
mathematics.)  The relationship could be a matter of historical
connection with the subject or with related matters, or of legal,
commercial, philosophical, ethical or political position regarding
them.

The "Invariant Sections" are certain Secondary Sections whose titles
are designated, as being those of Invariant Sections, in the notice
that says that the Document is released under this License.  If a
section does not fit the above definition of Secondary then it is not
allowed to be designated as Invariant.  The Document may contain zero
Invariant Sections.  If the Document does not identify any Invariant
Sections then there are none.

The "Cover Texts" are certain short passages of text that are listed,
as Front-Cover Texts or Back-Cover Texts, in the notice that says that
the Document is released under this License.  A Front-Cover Text may
be at most 5 words, and a Back-Cover Text may be at most 25 words.

A "Transparent" copy of the Document means a machine-readable copy,
represented in a format whose specification is available to the
general public, that is suitable for revising the document
straightforwardly with generic text editors or (for images composed of
pixels) generic paint programs or (for drawings) some widely available
drawing editor, and that is suitable for input to text formatters or
for automatic translation to a variety of formats suitable for input
to text formatters.  A copy made in an otherwise Transparent file
format whose markup, or absence of markup, has been arranged to thwart
or discourage subsequent modification by readers is not Transparent.
An image format is not Transparent if used for any substantial amount
of text.  A copy that is not "Transparent" is called "Opaque".

Examples of suitable formats for Transparent copies include plain
ASCII without markup, Texinfo input format, LaTeX input format, SGML
or XML using a publicly available DTD, and standard-conforming simple
HTML, PostScript or PDF designed for human modification.  Examples of
transparent image formats include PNG, XCF and JPG.  Opaque formats
include proprietary formats that can be read and edited only by
proprietary word processors, SGML or XML for which the DTD and/or
processing tools are not generally available, and the
machine-generated HTML, PostScript or PDF produced by some word
processors for output purposes only.

The "Title Page" means, for a printed book, the title page itself,
plus such following pages as are needed to hold, legibly, the material
this License requires to appear in the title page.  For works in
formats which do not have any title page as such, "Title Page" means
the text near the most prominent appearance of the work's title,
preceding the beginning of the body of the text.

A section "Entitled XYZ" means a named subunit of the Document whose
title either is precisely XYZ or contains XYZ in parentheses following
text that translates XYZ in another language.  (Here XYZ stands for a
specific section name mentioned below, such as "Acknowledgements",
"Dedications", "Endorsements", or "History".)  To "Preserve the Title"
of such a section when you modify the Document means that it remains a
section "Entitled XYZ" according to this definition.

The Document may include Warranty Disclaimers next to the notice which
states that this License applies to the Document.  These Warranty
Disclaimers are considered to be included by reference in this
License, but only as regards disclaiming warranties: any other
implication that these Warranty Disclaimers may have is void and has
no effect on the meaning of this License.


2. VERBATIM COPYING

You may copy and distribute the Document in any medium, either
commercially or noncommercially, provided that this License, the
copyright notices, and the license notice saying this License applies
to the Document are reproduced in all copies, and that you add no other
conditions whatsoever to those of this License.  You may not use
technical measures to obstruct or control the reading or further
copying of the copies you make or distribute.  However, you may accept
compensation in exchange for copies.  If you distribute a large enough
number of copies you must also follow the conditions in section 3.

You may also lend copies, under the same conditions stated above, and
you may publicly display copies.


3. COPYING IN QUANTITY

If you publish printed copies (or copies in media that commonly have
printed covers) of the Document, numbering more than 100, and the
Document's license notice requires Cover Texts, you must enclose the
copies in covers that carry, clearly and legibly, all these Cover
Texts: Front-Cover Texts on the front cover, and Back-Cover Texts on
the back cover.  Both covers must also clearly and legibly identify
you as the publisher of these copies.  The front cover must present
the full title with all words of the title equally prominent and
visible.  You may add other material on the covers in addition.
Copying with changes limited to the covers, as long as they preserve
the title of the Document and satisfy these conditions, can be treated
as verbatim copying in other respects.

If the required texts for either cover are too voluminous to fit
legibly, you should put the first ones listed (as many as fit
reasonably) on the actual cover, and continue the rest onto adjacent
pages.

If you publish or distribute Opaque copies of the Document numbering
more than 100, you must either include a machine-readable Transparent
copy along with each Opaque copy, or state in or with each Opaque copy
a computer-network location from which the general network-using
public has access to download using public-standard network protocols
a complete Transparent copy of the Document, free of added material.
If you use the latter option, you must take reasonably prudent steps,
when you begin distribution of Opaque copies in quantity, to ensure
that this Transparent copy will remain thus accessible at the stated
location until at least one year after the last time you distribute an
Opaque copy (directly or through your agents or retailers) of that
edition to the public.

It is requested, but not required, that you contact the authors of the
Document well before redistributing any large number of copies, to give
them a chance to provide you with an updated version of the Document.


4. MODIFICATIONS

You may copy and distribute a Modified Version of the Document under
the conditions of sections 2 and 3 above, provided that you release
the Modified Version under precisely this License, with the Modified
Version filling the role of the Document, thus licensing distribution
and modification of the Modified Version to whoever possesses a copy
of it.  In addition, you must do these things in the Modified Version:

A. Use in the Title Page (and on the covers, if any) a title distinct
   from that of the Document, and from those of previous versions
   (which should, if there were any, be listed in the History section
   of the Document).  You may use the same title as a previous version
   if the original publisher of that version gives permission.
B. List on the Title Page, as authors, one or more persons or entities
   responsible for authorship of the modifications in the Modified
   Version, together with at least five of the principal authors of the
   Document (all of its principal authors, if it has fewer than five),
   unless they release you from this requirement.
C. State on the Title page the name of the publisher of the
   Modified Version, as the publisher.
D. Preserve all the copyright notices of the Document.
E. Add an appropriate copyright notice for your modifications
   adjacent to the other copyright notices.
F. Include, immediately after the copyright notices, a license notice
   giving the public permission to use the Modified Version under the
   terms of this License, in the form shown in the Addendum below.
G. Preserve in that license notice the full lists of Invariant Sections
   and required Cover Texts given in the Document's license notice.
H. Include an unaltered copy of this License.
I. Preserve the section Entitled "History", Preserve its Title, and add
   to it an item stating at least the title, year, new authors, and
   publisher of the Modified Version as given on the Title Page.  If
   there is no section Entitled "History" in the Document, create one
   stating the title, year, authors, and publisher of the Document as
   given on its Title Page, then add an item describing the Modified
   Version as stated in the previous sentence.
J. Preserve the network location, if any, given in the Document for
   public access to a Transparent copy of the Document, and likewise
   the network locations given in the Document for previous versions
   it was based on.  These may be placed in the "History" section.
   You may omit a network location for a work that was published at
   least four years before the Document itself, or if the original
   publisher of the version it refers to gives permission.
K. For any section Entitled "Acknowledgements" or "Dedications",
   Preserve the Title of the section, and preserve in the section all
   the substance and tone of each of the contributor acknowledgements
   and/or dedications given therein.
L. Preserve all the Invariant Sections of the Document,
   unaltered in their text and in their titles.  Section numbers
   or the equivalent are not considered part of the section titles.
M. Delete any section Entitled "Endorsements".  Such a section
   may not be included in the Modified Version.
N. Do not retitle any existing section to be Entitled "Endorsements"
   or to conflict in title with any Invariant Section.
O. Preserve any Warranty Disclaimers.

If the Modified Version includes new front-matter sections or
appendices that qualify as Secondary Sections and contain no material
copied from the Document, you may at your option designate some or all
of these sections as invariant.  To do this, add their titles to the
list of Invariant Sections in the Modified Version's license notice.
These titles must be distinct from any other section titles.

You may add a section Entitled "Endorsements", provided it contains
nothing but endorsements of your Modified Version by various
parties--for example, statements of peer review or that the text has
been approved by an organization as the authoritative definition of a
standard.

You may add a passage of up to five words as a Front-Cover Text, and a
passage of up to 25 words as a Back-Cover Text, to the end of the list
of Cover Texts in the Modified Version.  Only one passage of
Front-Cover Text and one of Back-Cover Text may be added by (or
through arrangements made by) any one entity.  If the Document already
includes a cover text for the same cover, previously added by you or
by arrangement made by the same entity you are acting on behalf of,
you may not add another; but you may replace the old one, on explicit
permission from the previous publisher that added the old one.

The author(s) and publisher(s) of the Document do not by this License
give permission to use their names for publicity for or to assert or
imply endorsement of any Modified Version.


5. COMBINING DOCUMENTS

You may combine the Document with other documents released under this
License, under the terms defined in section 4 above for modified
versions, provided that you include in the combination all of the
Invariant Sections of all of the original documents, unmodified, and
list them all as Invariant Sections of your combined work in its
license notice, and that you preserve all their Warranty Disclaimers.

The combined work need only contain one copy of this License, and
multiple identical Invariant Sections may be replaced with a single
copy.  If there are multiple Invariant Sections with the same name but
different contents, make the title of each such section unique by
adding at the end of it, in parentheses, the name of the original
author or publisher of that section if known, or else a unique number.
Make the same adjustment to the section titles in the list of
Invariant Sections in the license notice of the combined work.

In the combination, you must combine any sections Entitled "History"
in the various original documents, forming one section Entitled
"History"; likewise combine any sections Entitled "Acknowledgements",
and any sections Entitled "Dedications".  You must delete all sections
Entitled "Endorsements".


6. COLLECTIONS OF DOCUMENTS

You may make a collection consisting of the Document and other documents
released under this License, and replace the individual copies of this
License in the various documents with a single copy that is included in
the collection, provided that you follow the rules of this License for
verbatim copying of each of the documents in all other respects.

You may extract a single document from such a collection, and distribute
it individually under this License, provided you insert a copy of this
License into the extracted document, and follow this License in all
other respects regarding verbatim copying of that document.


7. AGGREGATION WITH INDEPENDENT WORKS

A compilation of the Document or its derivatives with other separate
and independent documents or works, in or on a volume of a storage or
distribution medium, is called an "aggregate" if the copyright
resulting from the compilation is not used to limit the legal rights
of the compilation's users beyond what the individual works permit.
When the Document is included in an aggregate, this License does not
apply to the other works in the aggregate which are not themselves
derivative works of the Document.

If the Cover Text requirement of section 3 is applicable to these
copies of the Document, then if the Document is less than one half of
the entire aggregate, the Document's Cover Texts may be placed on
covers that bracket the Document within the aggregate, or the
electronic equivalent of covers if the Document is in electronic form.
Otherwise they must appear on printed covers that bracket the whole
aggregate.


8. TRANSLATION

Translation is considered a kind of modification, so you may
distribute translations of the Document under the terms of section 4.
Replacing Invariant Sections with translations requires special
permission from their copyright holders, but you may include
translations of some or all Invariant Sections in addition to the
original versions of these Invariant Sections.  You may include a
translation of this License, and all the license notices in the
Document, and any Warranty Disclaimers, provided that you also include
the original English version of this License and the original versions
of those notices and disclaimers.  In case of a disagreement between
the translation and the original version of this License or a notice
or disclaimer, the original version will prevail.

If a section in the Document is Entitled "Acknowledgements",
"Dedications", or "History", the requirement (section 4) to Preserve
its Title (section 1) will typically require changing the actual
title.


9. TERMINATION

You may not copy, modify, sublicense, or distribute the Document except
as expressly provided for under this License.  Any other attempt to
copy, modify, sublicense or distribute the Document is void, and will
automatically terminate your rights under this License.  However,
parties who have received copies, or rights, from you under this
License will not have their licenses terminated so long as such
parties remain in full compliance.


10. FUTURE REVISIONS OF THIS LICENSE

The Free Software Foundation may publish new, revised versions
of the GNU Free Documentation License from time to time.  Such new
versions will be similar in spirit to the present version, but may
differ in detail to address new problems or concerns.  See
http://www.gnu.org/copyleft/.

Each version of the License is given a distinguishing version number.
If the Document specifies that a particular numbered version of this
License "or any later version" applies to it, you have the option of
following the terms and conditions either of that specified version or
of any later version that has been published (not as a draft) by the
Free Software Foundation.  If the Document does not specify a version
number of this License, you may choose any version ever published (not
as a draft) by the Free Software Foundation.


ADDENDUM: How to use this License for your documents

To use this License in a document you have written, include a copy of
the License in the document and put the following copyright and
license notices just after the title page:

    Copyright (c)  YEAR  YOUR NAME.
    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.2
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".

If you have Invariant Sections, Front-Cover Texts and Back-Cover Texts,
replace the "with...Texts." line with this:

    with the Invariant Sections being LIST THEIR TITLES, with the
    Front-Cover Texts being LIST, and with the Back-Cover Texts being LIST.

If you have Invariant Sections without Cover Texts, or some other
combination of the three, merge those two alternatives to suit the
situation.

If your document contains nontrivial examples of program code, we
recommend releasing these examples in parallel under your choice of
free software license, such as the GNU General Public License,
to permit their use in free software.

--- NEW FILE: logo.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: manual.tex ---
% blahtex manual

% Copyright (c) 2006, David Harvey

% Permission is granted to copy, distribute and/or modify this document
% under the terms of the GNU Free Documentation License, Version 1.2
% or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
% Texts.  A copy of the license is included in the file GNU-FDL.

\documentclass{article}
\usepackage{html}      % latex2html package
\usepackage{ucs}       % for \unichar
\usepackage{graphicx}

\newcommand{\blahtexversion}{0.4.4}
\newcommand{\texcommand}[1]{\textbackslash{}#1}
\newcommand{\mylink}[1]{\htmladdnormallink{\texttt{#1}}{#1}}

[...1589 lines suppressed...]
\begin{itemize}
\item Added \texttt{--use-cjk-package} and \texttt{--japanese-font} options.
\item Added commands \texttt{\texcommand{cyr}} and \texttt{\texcommand{jap}}.
\item Added error messages:
\begin{itemize}
\item \texttt{WrongFontEncoding}
\item \texttt{WrongFontEncodingWithHint}
\item \texttt{IllegalNestedFontEncodigs}
\item \texttt{LatexPackageUnavailable}
\item \texttt{LatexFontNotSpecified}
\end{itemize}
\end{itemize}
\item Corrected MathML characters for \texttt{\texcommand{longrightarrow}} and friends; however they are currently disabled because of poor font support.
\item Fixed spacing for \texttt{\texcommand{substack}} and the \texttt{aligned} environment. Note however that Firefox still doesn't support the requisite \texttt{rowspacing} and \texttt{columnspacing} attributes, so it won't look right yet in Firefox.
\item Changed format of \texttt{--print-error-messages} slightly.
\item Finished adding MathML character names for all commands added in version 0.4.2.
\end{itemize}
\end{itemize}

\end{document}



From nobody at sheep.berlios.de  Sun Mar 26 12:14:31 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:14:31 +0200
Subject: [Blahtex-cvs] blahtex/blahtex blahtex-0.4-manual.pdf,1.1,NONE history.pdf,1.2,NONE
Message-ID: <200603261014.k2QAEUt15109@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex
In directory sheep:/tmp/cvs-serv24328

Removed Files:
	blahtex-0.4-manual.pdf history.pdf 
Log Message:
Update to blahtex-0.4.4


--- blahtex-0.4-manual.pdf DELETED ---

--- history.pdf DELETED ---



From nobody at sheep.berlios.de  Sun Mar 26 12:14:31 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:14:31 +0200
Subject: [Blahtex-cvs] blahtex/blahtex/source/BlahtexCore XmlNode.cpp,1.3,NONE XmlNode.h,1.3,NONE
Message-ID: <200603261014.k2QAEVt15113@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/blahtex/source/BlahtexCore
In directory sheep:/tmp/cvs-serv24328/source/BlahtexCore

Removed Files:
	XmlNode.cpp XmlNode.h 
Log Message:
Update to blahtex-0.4.4


--- XmlNode.cpp DELETED ---

--- XmlNode.h DELETED ---



From nobody at sheep.berlios.de  Sun Mar 26 12:16:14 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 12:16:14 +0200
Subject: [Blahtex-cvs] blahtex/includes DefaultSettings.php,1.16,1.17
Message-ID: <200603261016.k2QAGEt15208@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv24428/includes

Modified Files:
	DefaultSettings.php 
Log Message:
Bump blahtex version.


Index: DefaultSettings.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/DefaultSettings.php,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** DefaultSettings.php	23 Mar 2006 10:40:58 -0000	1.16
--- DefaultSettings.php	26 Mar 2006 10:16:37 -0000	1.17
***************
*** 33,37 ****
  
  /** MediaWiki version number */
! $wgVersion			= '1.6alpha + blahtex 0.4.4-pre2';
  
  /** Name of the site. It must be changed in LocalSettings.php */
--- 33,37 ----
  
  /** MediaWiki version number */
! $wgVersion			= '1.6alpha + blahtex 0.4.4';
  
  /** Name of the site. It must be changed in LocalSettings.php */
***************
*** 1080,1083 ****
--- 1080,1085 ----
  /** Location of the blahtex binary. If empty, texvc is used instead */
  $wgBlahtex = '';
+ /** Command-line options for blahtex */
+ $wgBlahtexOptions = '--texvc-compatible-commands --mathml-version-1-fonts --disallow-plane-1 --spacing strict';
  /** Whether to use blahtex's "--compute-vertical-shift" facility */
  $wgUseBlahtexVerticalShift = false;



From nobody at sheep.berlios.de  Sun Mar 26 13:00:44 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Sun, 26 Mar 2006 13:00:44 +0200
Subject: [Blahtex-cvs] blahtex/includes Math.php,1.28,1.29
Message-ID: <200603261100.k2QB0it16619@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv12882

Modified Files:
	Math.php 
Log Message:
* processTexvcOutput: set hash to NULL if run was unsuccessful
* processBlahtexOutput: do not attempt to move PNG file if it wasn't
	generated.
* _recall: reorder code


Index: Math.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Math.php,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** Math.php	24 Mar 2006 11:28:08 -0000	1.28
--- Math.php	26 Mar 2006 11:01:08 -0000	1.29
***************
*** 286,294 ****
  		}
  		
  		$tmp = $this->moveToMathDir( "{$hash}.png" );
! 		if ( $tmp !== false ) 
  			return $tmp;
  
- 		$this->hash = $hash;
  		return false;
  	}
--- 286,296 ----
  		}
  		
+ 		$this->hash = $hash;
  		$tmp = $this->moveToMathDir( "{$hash}.png" );
! 		if ( $tmp !== false ) {
! 			$this->hash = NULL;
  			return $tmp;
+ 		}
  
  		return false;
  	}
***************
*** 365,375 ****
  			if (isset($results["mathmlMarkup"]))	 
  				$this->mathml = $results['mathmlMarkup'];
! 			if (isset($results["blahtex:png:md5"])) 
  				$this->hash = $results["blahtex:png:md5"];
  			if (isset($results["blahtex:png:vshift"]))
  				$this->verticalShift = $results["blahtex:png:vshift"];
- 			$tmp = $this->moveToMathDir( "{$this->hash}.png" );
- 			if ( $tmp !== false ) 
- 				return $tmp;
  			return false;
  
--- 367,378 ----
  			if (isset($results["mathmlMarkup"]))	 
  				$this->mathml = $results['mathmlMarkup'];
! 			if (isset($results["blahtex:png:md5"])) {
  				$this->hash = $results["blahtex:png:md5"];
+ 				$tmp = $this->moveToMathDir( "{$this->hash}.png" );
+ 				if ( $tmp !== false ) 
+ 					return $tmp;
+ 			}
  			if (isset($results["blahtex:png:vshift"]))
  				$this->verticalShift = $results["blahtex:png:vshift"];
  			return false;
  
***************
*** 386,389 ****
--- 389,393 ----
  	/**
  	 * Move a file from $wgTmpDirectory to a directory under $wgMathDirectory.
+ 	 * Assumes that $this->hash is set.
  	 * Returns false or an error message.
  	 */
***************
*** 428,451 ****
  		);
  
! 		if( $rpage !== false ) {
! 			if( $rpage->math_outputhash == '' )
! 				$this->hash = NULL;
! 			else {
! 				// Tailing 0x20s can get dropped by the database, add them back on if necessary:
! 				$xhash = unpack( 'H32md5', $rpage->math_outputhash . "                " );
! 				$this->hash = $xhash ['md5'];
! 			}
! 			
! 			$this->conservativeness = $rpage->math_html_conservativeness;
! 			$this->html = $rpage->math_html;
! 			$this->mathml = $rpage->math_mathml;
! 			
! 			if( file_exists( $this->_getHashPath() . "/{$this->hash}.png" ) ) {
! 				return true;
! 			}
  
! 			if( file_exists( $wgMathDirectory . "/{$this->hash}.png" ) ) {
! 				$hashpath = $this->_getHashPath();
  
  				if( !file_exists( $hashpath ) ) {
  					if( !@wfMkdirParents( $hashpath, 0755 ) ) {
--- 432,460 ----
  		);
  
! 		if( $rpage === false ) 
! 			return false; // Missing from the database
  
! 		if( $rpage->math_outputhash == '' )
! 			$this->hash = NULL;
! 		else {
! 			// Tailing 0x20s can get dropped by the database, add them back on if necessary:
! 			$xhash = unpack( 'H32md5', $rpage->math_outputhash . "                " );
! 			$this->hash = $xhash ['md5'];
! 		}
! 		
! 		$this->conservativeness = $rpage->math_html_conservativeness;
! 		$this->html = $rpage->math_html;
! 		$this->mathml = $rpage->math_mathml;
! 		
! 		if( !$this->html && !$this->mathml && !$this->hash )
! 			return false; // Database contains no useful information
  
+ 		if( $this->hash) {
+ 			$hashpath = $this->_getHashPath();
+ 			
+ 			// All files used to be stored directly under $wgMathDirectory
+ 			// Move them to the new layout if necessary
+ 			if( file_exists( $wgMathDirectory . "/{$this->hash}.png" )
+ 			    && !file_exists( $hashpath . "/{$this->hash}.png" ) ) {
  				if( !file_exists( $hashpath ) ) {
  					if( !@wfMkdirParents( $hashpath, 0755 ) ) {
***************
*** 457,461 ****
  				if ( function_exists( "link" ) ) {
  					return link ( $wgMathDirectory . "/{$this->hash}.png",
! 							$hashpath . "/{$this->hash}.png" );
  				} else {
  					return rename ( $wgMathDirectory . "/{$this->hash}.png",
--- 466,470 ----
  				if ( function_exists( "link" ) ) {
  					return link ( $wgMathDirectory . "/{$this->hash}.png",
! 						      $hashpath . "/{$this->hash}.png" );
  				} else {
  					return rename ( $wgMathDirectory . "/{$this->hash}.png",
***************
*** 463,485 ****
  				}
  			}
  
  			global $wgUseBlahtexVerticalShift;
! 			if ( $wgUseBlahtexVerticalShift && $this->hash )
! 			{
  				$verticalShiftFile = @fopen( "$hashpath/{$this->hash}.vshift", "rb" );
! 				if ( !($verticalShiftFile === false) )
! 				{
  					$this->verticalShift = @fgets( $verticalShiftFile );
  					@fclose( $verticalShiftFile );
  				}
  				// Silently ignore vertical shift if the file is missing
! 			}
! 
! 			if( $this->html || $this->mathml || $this->hash )
! 				return true;
  		}
  		
! 		# Missing from the database and/or the render cache
! 		return false;
  	}
  
--- 472,493 ----
  				}
  			}
+ 			
+ 			if ( !file_exists( $hashpath . "/{$this->hash}.png" ) ) {
+ 				$this->hash = NULL; // File disappeared from the render cache
+ 				return false;
+ 			}
  
  			global $wgUseBlahtexVerticalShift;
! 			if ( $wgUseBlahtexVerticalShift && $this->hash ) {
  				$verticalShiftFile = @fopen( "$hashpath/{$this->hash}.vshift", "rb" );
! 				if ( !($verticalShiftFile === false) ) {
  					$this->verticalShift = @fgets( $verticalShiftFile );
  					@fclose( $verticalShiftFile );
  				}
  				// Silently ignore vertical shift if the file is missing
! 			}			
  		}
  		
! 		return true;
  	}
  



From nobody at sheep.berlios.de  Fri Mar 31 03:21:06 2006
From: nobody at sheep.berlios.de (jitseniesen)
Date: Fri, 31 Mar 2006 03:21:06 +0200
Subject: [Blahtex-cvs] blahtex/includes Math.php,1.29,1.30
Message-ID: <200603310121.k2V1L6t10616@bat.berlios.de>

Update of /cvsroot/blahtex/blahtex/includes
In directory sheep:/tmp/cvs-serv3579

Modified Files:
	Math.php 
Log Message:
moveToMathDir(): add "return false" (bugfix)


Index: Math.php
===================================================================
RCS file: /cvsroot/blahtex/blahtex/includes/Math.php,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** Math.php	26 Mar 2006 11:01:08 -0000	1.29
--- Math.php	31 Mar 2006 01:21:14 -0000	1.30
***************
*** 407,410 ****
--- 407,411 ----
  			return $this->_error( 'math_output_error' );
  		}
+ 		return false;
  	}
  



